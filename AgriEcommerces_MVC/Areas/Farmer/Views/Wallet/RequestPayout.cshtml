@model dynamic
@{
    ViewData["Title"] = "Yêu cầu rút tiền";
}

<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-money-bill-wave"></i> Yêu cầu rút tiền</h5>
    </div>
    <div class="card-body">

        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger">@TempData["Error"]</div>
        }
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success">@TempData["Success"]</div>
        }

        <div class="alert alert-info">
            Số dư khả dụng: <strong>@ViewBag.Balance.ToString("N0") VNĐ</strong>
        </div>

        <form asp-action="RequestPayout" method="post" id="payout-form">
            @Html.AntiForgeryToken()

            <div class="mb-3">
                <label class="form-label">Số tiền muốn rút (VNĐ)</label>
                <input type="number" name="amount" class="form-control" min="100000" step="10000" required placeholder="Tối thiểu 100.000">
            </div>

            <hr />
            <h6>Thông tin tài khoản nhận tiền (VietQR)</h6>

            <div class="mb-3">
                <label class="form-label">Ngân hàng</label>
                <select id="bank-select" class="form-select" required>
                    <option value="">-- Đang tải danh sách ngân hàng... --</option>
                </select>
                <input type="hidden" name="bankCode" id="hidden_bankCode" /> <input type="hidden" name="bankName" id="hidden_bankName" /> <input type="hidden" name="bankBin" id="hidden_bankBin" />
            </div>

            <div class="mb-3">
                <label class="form-label">Số tài khoản</label>
                <input type="text" name="accountNumber" class="form-control" required placeholder="Nhập số tài khoản">
            </div>

            <div class="mb-3">
                <label class="form-label">Tên chủ tài khoản (Viết hoa không dấu)</label>
                <input type="text" name="accountName" class="form-control" required placeholder="NGUYEN VAN A" style="text-transform: uppercase;">
            </div>

            <button type="submit" class="btn btn-success w-100"><i class="fas fa-paper-plane"></i> Gửi yêu cầu</button>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Gọi API lấy danh sách ngân hàng Việt Nam (Miễn phí từ VietQR)
            $.getJSON("https://api.vietqr.io/v2/banks", function (response) {
                if (response.code == "00") {
                    var options = '<option value="">-- Chọn ngân hàng --</option>';
                    $.each(response.data, function (index, bank) {
                        // shortName: VCB, MB, TCB...
                        // bin: 970436...
                        options += `<option value="${bank.shortName}" data-bin="${bank.bin}" data-name="${bank.shortName} - ${bank.name}">${bank.shortName} - ${bank.name}</option>`;
                    });
                    $('#bank-select').html(options);
                }
            });

            // Khi chọn ngân hàng, cập nhật vào các input ẩn
            $('#bank-select').change(function () {
                var selectedOption = $(this).find('option:selected');
                var shortName = $(this).val(); // VD: VCB
                var bin = selectedOption.data('bin'); // VD: 970436
                var fullName = selectedOption.data('name');

                $('#hidden_bankCode').val(shortName);
                $('#hidden_bankBin').val(bin);
                $('#hidden_bankName').val(fullName);
            });
        });
    </script>
}