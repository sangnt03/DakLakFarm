@using AgriEcommerces_MVC.Controllers
@model List<ConversationViewModel>

@{
    ViewData["Title"] = "Tin nhắn khách hàng";

    var selectedUserId = ViewBag.SelectedUserId as string;
    var selectedProductId = ViewBag.SelectedProductId as int?;
}

<style>
    /* LAYOUT CƠ BẢN */
    .inbox-wrapper {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-top: 20px;
        margin-bottom: 20px;
        height: 600px;
        display: flex;
        border: 1px solid #e0e0e0;
    }

    /* CỘT TRÁI: DANH SÁCH */
    .inbox-list-panel {
        width: 350px;
        border-right: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
    }

    .inbox-header {
        background: linear-gradient(135deg, #00C853 0%, #009624 100%);
        padding: 15px 20px;
        color: #fff;
        flex-shrink: 0;
    }

    .conversation-list {
        list-style: none;
        padding: 0;
        margin: 0;
        overflow-y: auto;
        flex: 1;
    }

    .conversation-item {
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: background 0.2s;
    }

        .conversation-item:hover {
            background: #e8f5e9;
        }

        .conversation-item.active {
            background: #fff;
            border-left: 4px solid #00C853;
        }

    .conversation-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #00C853;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        flex-shrink: 0;
    }

    .conversation-info {
        flex: 1;
        min-width: 0;
    }

    .user-name {
        font-weight: 600;
        margin-bottom: 2px;
        color: #333;
    }

    .last-msg {
        font-size: 13px;
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* CỘT PHẢI: KHUNG CHAT */
    .inbox-chat-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
    }

    #chatBoxContainer {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .empty-state {
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #999;
    }

        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            color: #ddd;
        }

    @@media (max-width: 767px) {
        .container-fluid

    {
        padding: 0 !important;
    }

    .inbox-wrapper {
        height: calc(100vh - 60px);
        margin: 0;
        border-radius: 0;
        box-shadow: none;
    }

    /* Mặc định: Hiện danh sách, ẩn chat */
    .inbox-list-panel {
        width: 100%;
        border-right: none;
    }

    .inbox-chat-panel {
        display: none;
        width: 100%;
    }

    /* Khi có class "show-chat" -> Ẩn danh sách, hiện chat */
    .inbox-wrapper.show-chat .inbox-list-panel {
        display: none;
    }

    .inbox-wrapper.show-chat .inbox-chat-panel {
        display: flex;
    }

    /* Điều chỉnh kích thước */
    .conversation-avatar {
        width: 40px;
        height: 40px;
        font-size: 16px;
    }

    .conversation-item {
        padding: 12px 15px;
    }

    .inbox-header h5 {
        font-size: 18px;
    }

    .user-name {
        font-size: 15px;
    }

    .last-msg {
        font-size: 12px;
    }

    }

    /* Tablet */
    @@media (min-width: 768px) and (max-width: 991px) {
        .inbox-list-panel

    {
        width: 300px;
    }

    .conversation-avatar {
        width: 40px;
        height: 40px;
    }

    }

    /* Desktop lớn */
    @@media (min-width: 1200px) {
        .inbox-list-panel

    {
        width: 380px;
    }

    }
</style>

<div class="container-fluid px-4">
    <div class="inbox-wrapper" id="inboxWrapper">

        <div class="inbox-list-panel">
            <div class="inbox-header">
                <h5 class="m-0"><i class="fas fa-comments"></i> Chat khách hàng</h5>
            </div>

            @if (Model == null || !Model.Any())
            {
                <div class="p-4 text-center text-muted">
                    <small>Chưa có tin nhắn nào</small>
                </div>
            }
            else
            {
                <ul class="conversation-list">
                    @foreach (var conv in Model)
                    {
                        var activeClass = (conv.UserId == selectedUserId) ? "active" : "";

                        <li class="conversation-item @activeClass"
                            id="conv-@conv.UserId"
                            onclick="loadChatBox('@conv.UserId', @selectedProductId)">

                            <div class="conversation-avatar">
                                @conv.AvatarChar
                            </div>
                            <div class="conversation-info">
                                <div class="d-flex justify-content-between">
                                    <div class="user-name">@conv.UserName</div>
                                    @if (conv.Timestamp.HasValue)
                                    {
                                        <small class="text-muted" style="font-size: 11px;">
                                            @conv.Timestamp.Value.ToString("HH:mm dd/MM")
                                        </small>
                                    }
                                </div>
                                <div class="last-msg">
                                    @(conv.LastMessage ?? "...")
                                </div>
                            </div>
                        </li>
                    }
                </ul>
            }
        </div>

        <div class="inbox-chat-panel">
            <div id="chatBoxContainer">
                <div class="empty-state">
                    <i class="far fa-comments"></i>
                    <p>Chọn một khách hàng để bắt đầu trò chuyện</p>
                </div>
            </div>
        </div>

    </div>
</div>

@section Scripts {
    <script>
        const preSelectedUserId = '@selectedUserId';
        const preSelectedProductId = '@selectedProductId';

        $(document).ready(function() {
            if (preSelectedUserId) {
                loadChatBox(preSelectedUserId, preSelectedProductId);
            }
        });

        function loadChatBox(userId, productId) {
            $('.conversation-item').removeClass('active');
            $(`#conv-${userId}`).addClass('active');

            // Trên mobile: chuyển sang hiển thị chat
            if (window.innerWidth < 768) {
                $('#inboxWrapper').addClass('show-chat');
            }

            $('#chatBoxContainer').html(`
                <div class="empty-state">
                    <div class="spinner-border text-success" role="status"></div>
                    <p class="mt-2">Đang tải tin nhắn...</p>
                </div>
            `);

            const pId = productId ? productId : 0;
            const url = '@Url.Action("GetChatBoxPartial", "ChatShop", new { area = "Farmer" })';

            $.get(`${url}?receiverId=${userId}&productId=${pId}`, function(data) {
                $('#chatBoxContainer').html(data);
            })
            .fail(function() {
                $('#chatBoxContainer').html('<p class="text-center mt-5 text-danger">Lỗi tải tin nhắn.</p>');
            });
        }

        // Hàm quay lại danh sách (gọi từ _ChatBoxShop)
        window.backToConversationList = function() {
            $('#inboxWrapper').removeClass('show-chat');
        };

        var shopListConnection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub?userType=Farmer")
            .withAutomaticReconnect()
            .build();

        shopListConnection.on("ReceiveMessage", function (data) {
            console.log("📨 Shop List nhận tin:", data);

            // Tìm item trong danh sách (khách hàng)
            var $itemSender = $("#conv-" + data.senderId);
            var $itemReceiver = $("#conv-" + data.receiverId);
            var $targetItem = $itemSender.length ? $itemSender : $itemReceiver;

            if ($targetItem.length > 0) {
                // 1. Cập nhật nội dung tin nhắn cuối
                var content = data.content;
                if(data.productId) content = "SP #" + data.productId + ": " + content;
                $targetItem.find(".last-msg").text(content);

                // 2. Cập nhật thời gian (Format HH:mm dd/MM)
                var date = new Date(data.timestamp);
                var timeStr = date.getHours().toString().padStart(2, '0') + ":" +
                              date.getMinutes().toString().padStart(2, '0') + " " +
                              date.getDate().toString().padStart(2, '0') + "/" +
                              (date.getMonth() + 1).toString().padStart(2, '0');

                $targetItem.find("small.text-muted").text(timeStr);

                // 3. Đưa item lên đầu danh sách
                $targetItem.prependTo($targetItem.parent());

                // 4. Highlight tin nhắn mới nếu không active
                if (!$targetItem.hasClass('active')) {
                    $targetItem.css("background-color", "#f0fff4");
                    $targetItem.find(".last-msg").css("font-weight", "bold");

                    // Bỏ highlight sau 2 giây
                    setTimeout(function() {
                        $targetItem.css("background-color", "");
                    }, 2000);
                }
            } else {
                console.log("⚠️ Không tìm thấy conversation item cho:", data.senderId, data.receiverId);
            }
        });

        shopListConnection.start().then(function() {
            console.log("✅ Shop List SignalR Connected!");
        }).catch(function (err) {
            console.error("❌ Shop List SignalR Error: ", err.toString());
        });
    </script>
}