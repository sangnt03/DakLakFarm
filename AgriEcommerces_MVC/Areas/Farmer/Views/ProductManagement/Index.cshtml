@{
    ViewData["Title"] = "Quản lý sản phẩm";
}

<style>
    /* --- Clean White, Green & Yellow Theme --- */
    :root {
        --primary-green: #10b981;
        --primary-green-dark: #059669;
        --light-green: #d1fae5;
        --accent-yellow: #fbbf24;
        --accent-yellow-dark: #f59e0b;
        --light-yellow: #fef3c7;
        --white: #ffffff;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
    }

    body {
        background-color: var(--gray-50);
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        color: var(--gray-700);
    }

    /* Header styling */
    .page-title {
        color: var(--primary-green-dark);
        font-weight: 800;
        font-size: 1.875rem;
        margin-bottom: 2rem;
        text-align: center;
        letter-spacing: -0.025em;
    }

    /* Main container */
    .main-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Button styling */
    .btn-create-new {
        background-color: var(--primary-green);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        color: var(--white);
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s;
        box-shadow: var(--shadow-sm);
    }

        .btn-create-new:hover {
            background-color: var(--primary-green-dark);
            box-shadow: var(--shadow);
            transform: translateY(-1px);
            color: var(--white);
        }

    /* Table card & responsive wrapper */
    .table-card {
        background: var(--white);
        border-radius: 1rem;
        box-shadow: var(--shadow);
        border: 1px solid var(--gray-200);
        overflow: hidden; /* Đảm bảo bo góc hoạt động */
    }

    .table-responsive-wrapper {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* Cuộn mượt trên iOS */
    }

    /* Custom table styling */
    .custom-table {
        width: 100%;
        margin-bottom: 0;
        border-collapse: separate;
        border-spacing: 0;
        white-space: nowrap; /* Ngăn xuống dòng để giữ layout đẹp trên desktop */
    }

        .custom-table th {
            background-color: var(--gray-50);
            color: var(--gray-600);
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .custom-table td {
            padding: 1rem 1.25rem;
            vertical-align: middle;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .custom-table tbody tr:last-child td {
            border-bottom: none;
        }

        .custom-table tbody tr:hover {
            background-color: var(--gray-50);
        }

    /* Column specifics */
    .col-thumb img {
        width: 48px;
        height: 48px;
        border-radius: 0.5rem;
        object-fit: cover;
        border: 1px solid var(--gray-200);
    }

    .product-name {
        font-weight: 600;
        color: var(--gray-700);
        white-space: normal; /* Cho phép tên sản phẩm xuống dòng nếu quá dài */
        max-width: 200px;
    }

    .category-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background-color: var(--light-green);
        color: var(--primary-green-dark);
        font-weight: 600;
        font-size: 0.75rem;
        border-radius: 9999px;
    }

    .price-text {
        font-weight: 600;
        color: var(--primary-green-dark);
    }

    .description-text {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Action buttons group */
    .action-group {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
    }

    .action-btn {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        border: none;
        transition: all 0.2s;
        color: var(--white);
        box-shadow: var(--shadow-sm);
    }

    .btn-edit {
        background-color: var(--accent-yellow);
    }

        .btn-edit:hover {
            background-color: var(--accent-yellow-dark);
            transform: translateY(-1px);
        }

    .btn-delete {
        background-color: #ef4444;
    }

        .btn-delete:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }

    /* --- Responsive Media Queries --- */
    @@media (max-width: 992px) {
        .main-container {
            padding: 1rem;
        }

        .page-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }
        /* Ẩn bớt cột trên tablet/mobile */
        .col-desc, .col-date {
            display: none;
        }

        .product-name {
            max-width: 150px;
        }
    }

    @@media (max-width: 576px) {
        .btn-create-new span {
            display: none; /* Ẩn chữ trên nút thêm mới khi màn hình quá nhỏ */
        }

        .btn-create-new {
            padding: 0.5rem;
        }

        .col-unit { /* Ẩn thêm cột đơn vị trên mobile nhỏ */
            display: none;
        }

        .custom-table th, .custom-table td {
            padding: 0.75rem 0.5rem; /* Giảm padding */
        }
    }
</style>

<div class="main-container">
    <h2 class="page-title">@ViewData["Title"]</h2>

    <div class="d-flex justify-content-end mb-4">
        <button id="btnCreate" class="btn-create-new">
            <i class="fas fa-plus"></i>
            <span>Thêm sản phẩm mới</span>
        </button>
    </div>

    <div class="table-card">
        <div class="table-responsive-wrapper">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th style="width: 70px;">Ảnh</th>
                        <th>Tên sản phẩm</th>
                        <th class="text-center">Danh mục</th>
                        <th class="text-end">Giá bán</th>
                        <th class="text-center">Tồn kho</th>
                        <th class="text-center col-unit">Đơn vị</th>
                        <th class="col-desc">Mô tả</th>
                        <th class="col-date">Ngày tạo</th>
                        <th class="text-end" style="min-width: 100px;">Thao tác</th>
                    </tr>
                </thead>
                <tbody id="productTableBody">
                </tbody>
            </table>
        </div>
    </div>
</div>

@Html.Partial("_ProductFormPartial")

@section Scripts {
    <script>
        $(document).ready(function () {
            let categories = [];
            let editingProductId = null;

            const getModal = () => bootstrap.Modal.getOrCreateInstance(document.getElementById('productModal'));
            const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);

            function loadCategories() {
                $.get('/api/farmer/categories').done(data => {
                    categories = data;
                    const $select = $('#categoryId').empty().append('<option value="">-- Chọn danh mục --</option>');
                    categories.forEach(cat => $select.append(`<option value="${cat.categoryId}">${cat.categoryName}</option>`));
                });
            }

            function loadProducts() {
                $('#productTableBody').html('<tr><td colspan="9" class="text-center py-4 text-muted">Đang tải dữ liệu...</td></tr>');
                $.get('/api/farmer/products')
                    .done(renderProductTable)
                    .fail(() => $('#productTableBody').html('<tr><td colspan="9" class="text-center py-4 text-danger">Lỗi tải dữ liệu.</td></tr>'));
            }

            function renderProductTable(products) {
                const $tbody = $('#productTableBody').empty();
                if (!products?.length) {
                    $tbody.append('<tr><td colspan="9" class="text-center py-5 text-muted">Chưa có sản phẩm nào.</td></tr>');
                    return;
                }

                products.forEach(p => {
                    const imgHtml = p.imageUrls?.length
                        ? `<div class="col-thumb"><img src="${p.imageUrls[0]}" alt="${p.productName}"></div>`
                        : '<div class="col-thumb"><div class="bg-light rounded d-flex align-items-center justify-content-center border" style="width:48px;height:48px"><i class="fas fa-image text-muted"></i></div></div>';

                    $tbody.append(`
                        <tr>
                            <td>${imgHtml}</td>
                            <td><div class="product-name" title="${p.productName}">${p.productName}</div></td>
                            <td class="text-center"><span class="category-badge">${p.categoryName}</span></td>
                            <td class="text-end"><span class="price-text">${formatCurrency(p.price)}</span></td>
                            <td class="text-center">${p.quantityAvailable}</td>
                            <td class="text-center text-muted col-unit">${p.unit || '-'}</td>
                            <td class="col-desc"><div class="description-text" title="${p.description || ''}">${p.description || ''}</div></td>
                            <td class="text-muted small col-date">${new Date(p.createdAt).toLocaleDateString('vi-VN')}</td>
                            <td>
                                <div class="action-group">
                                    <button class="action-btn btn-edit" data-id="${p.productId}" title="Sửa"><i class="fas fa-pen" style="font-size: 12px;"></i></button>
                                    <button class="action-btn btn-delete" data-id="${p.productId}" data-name="${p.productName}" title="Xóa"><i class="fas fa-trash" style="font-size: 12px;"></i></button>
                                </div>
                            </td>
                        </tr>
                    `);
                });
            }

            function openModal(mode, product = null) {
                editingProductId = mode === 'edit' ? product.productId : null;
                $('#productForm')[0].reset();
                $('#productModalLabel').text(mode === 'create' ? 'Thêm sản phẩm mới' : 'Cập nhật sản phẩm');
                $('#currentImages').empty().toggle(mode === 'edit');
                $('#productImages').prop('required', mode === 'create');

                if (mode === 'edit' && product) {
                    $('#productName').val(product.productName);
                    $('#categoryId').val(product.categoryId);
                    $('#price').val(product.price);
                    $('#quantityAvailable').val(product.quantityAvailable);
                    $('#unit').val(product.unit);
                    $('#description').val(product.description);
                    product.imageUrls?.forEach(url => {
                        $('#currentImages').append(`<img src="${url}" class="rounded border me-2 mb-2" style="width: 80px; height: 80px; object-fit: cover;">`);
                    });
                }
                getModal().show();
            }

            $('#btnCreate').click(() => openModal('create'));
            $('#productForm').on('submit', function(e) {
                e.preventDefault();
                const $btn = $(this).find('button[type="submit"]').prop('disabled', true);
                const originalText = $btn.html();
                $btn.html('<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...');

                $.ajax({
                    url: editingProductId ? `/api/farmer/products/${editingProductId}` : '/api/farmer/products',
                    type: editingProductId ? 'PUT' : 'POST',
                    data: new FormData(this),
                    processData: false,
                    contentType: false
                }).done(() => { getModal().hide(); loadProducts(); })
                  .fail(xhr => alert('Lỗi: ' + (xhr.responseJSON?.message || xhr.statusText)))
                  .always(() => $btn.prop('disabled', false).html(originalText));
            });

            $(document).on('click', '.btn-edit', function() {
                $.get(`/api/farmer/products/${$(this).data('id')}`).done(p => openModal('edit', p));
            });

            $(document).on('click', '.btn-delete', function() {
                if (confirm(`Xóa sản phẩm "${$(this).data('name')}"?`)) {
                    $.ajax({ url: `/api/farmer/products/${$(this).data('id')}`, type: 'DELETE' }).done(loadProducts);
                }
            });

            loadCategories();
            loadProducts();
        });
    </script>
}