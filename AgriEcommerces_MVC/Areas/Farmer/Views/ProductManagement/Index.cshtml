@{
    ViewData["Title"] = "Quản lý sản phẩm";
}

<style>
    /* Mint & Lemon Theme - Tươi mát & Năng động */
    :root {
        --mint-primary: #10b981;
        --mint-light: #6ee7b7;
        --mint-lighter: #a7f3d0;
        --mint-lightest: #d1fae5;
        --lemon-primary: #fbbf24;
        --lemon-light: #fcd34d;
        --lemon-lighter: #fde68a;
        --lemon-lightest: #fef3c7;
        --gradient-fresh: linear-gradient(135deg, var(--mint-primary) 0%, var(--lemon-primary) 100%);
        --gradient-soft: linear-gradient(135deg, var(--mint-lightest) 0%, var(--lemon-lightest) 100%);
        --shadow-fresh: 0 10px 25px rgba(16, 185, 129, 0.15);
        --shadow-hover: 0 15px 35px rgba(16, 185, 129, 0.25);
    }

    body {
        background: linear-gradient(135deg, #f0fdfa 0%, #fffbeb 50%, #f0fdf4 100%);
        min-height: 100vh;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* Header styling */
    h2 {
        background: var(--gradient-fresh);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: 700;
        font-size: 2.5rem;
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
    }

    h2::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 4px;
        background: var(--gradient-fresh);
        border-radius: 2px;
    }

    /* Main container */
    .container-fluid {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Create button */
    #btnCreate {
        background: var(--gradient-fresh);
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        color: white;
        font-weight: 600;
        font-size: 1rem;
        box-shadow: var(--shadow-fresh);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        margin-bottom: 2rem;
    }

    #btnCreate::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    #btnCreate:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
    }

    #btnCreate:hover::before {
        left: 100%;
    }

    /* Table container */
    .table-container {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: var(--shadow-fresh);
        overflow: hidden;
        border: 1px solid rgba(16, 185, 129, 0.1);
    }

    /* Table styling */
    .table {
        margin-bottom: 0;
        table-layout: fixed;
    }

    .table thead th {
        background: #F7FFF7
        color: #92400e;
        border: none;
        padding: 1rem 0.75rem;
        font-weight: 600;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        position: relative;
    }

    .table thead th::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 2px;
                background: #a7f3d0;
    }

    .table tbody tr {
        transition: all 0.3s ease;
        border: none;
    }

    .table tbody tr:nth-child(even) {
        background: var(--gradient-soft);
    }

    .table tbody tr:nth-child(odd) {
        background: rgba(255, 255, 255, 0.7);
    }

    .table tbody tr:hover {
        background: linear-gradient(135deg, var(--mint-lighter) 0%, var(--lemon-lighter) 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.15);
    }

    .table tbody td {
        padding: 1rem 0.75rem;
        border: none;
        vertical-align: middle;
        position: relative;
    }

    /* Image styling */
    .table tbody td img {
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }

    .table tbody td img:hover {
        transform: scale(1.1);
    }

    /* Price styling */
    .table tbody td:nth-child(4) {
        font-weight: 600;
        color: var(--mint-primary);
        font-size: 1.1rem;
    }

    /* Description column control */
    #productTableBody td:nth-child(7) {
        max-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: #6b7280;
        font-style: italic;
    }

    /* Action buttons */
    .btn-edit {
        background: linear-gradient(135deg, var(--lemon-primary) 0%, var(--lemon-light) 100%);
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
    }

    .btn-edit:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(251, 191, 36, 0.4);
        background: linear-gradient(135deg, var(--lemon-light) 0%, var(--lemon-primary) 100%);
    }

    .btn-delete {
        background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
        border: none;
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }

    .btn-delete:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
    }

    /* Empty state */
    .text-center {
        color: #6b7280;
        font-style: italic;
        padding: 3rem !important;
        background: var(--gradient-soft);
    }

    /* Quantity and unit styling */
    .table tbody td:nth-child(5),
    .table tbody td:nth-child(6) {
        font-weight: 600;
        color: var(--mint-primary);
    }

    /* Date styling */
    .table tbody td:nth-child(8) {
        color: #6b7280;
        font-size: 0.9rem;
    }

    /* Responsive enhancements */
    @@media (max-width: 768px) {
        .container-fluid {
            padding: 1rem;
        }
        
        h2 {
            font-size: 2rem;
        }
        
        .table-container {
            border-radius: 15px;
        }
        
        .table thead th {
            padding: 0.75rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .table tbody td {
            padding: 0.75rem 0.5rem;
        }
    }

    /* Loading animation for future use */
    @@keyframes shimmer {
        0% {
            background-position: -1000px 0;
        }
        100% {
            background-position: 1000px 0;
        }
    }

    /* Category badge styling */
    .table tbody td:nth-child(3) {
        font-weight: 500;
        color: var(--mint-primary);
        background: var(--mint-lightest);
        border-radius: 12px;
        text-align: center;
        margin: 4px;
        padding: 4px 8px !important;
    }

    /* Fresh accent lines */
    .table-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--gradient-fresh);
        z-index: 1;
    }
</style>

<div class="container-fluid">
    <h2>@ViewData["Title"]</h2>
    
    <button id="btnCreate" class="btn mb-3">
        <i class="fas fa-plus me-2"></i>Thêm sản phẩm
    </button>

    <div class="table-container position-relative">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th style="width: 10%;">Ảnh</th>
                    <th style="width: 15%;">Tên</th>
                    <th style="width: 10%;">Danh mục</th>
                    <th style="width: 10%;">Giá</th>
                    <th style="width: 5%;">SL</th>
                    <th style="width: 8%;">Đơn vị</th>
                    <th style="width: 30%;">Mô tả</th>
                    <th style="width: 15%;">Ngày tạo</th>
                    <th style="width: 12%;">Thao tác</th>
                </tr>
            </thead>
            <tbody id="productTableBody">
                <!-- JS sẽ render -->     
            </tbody>
        </table>
    </div>
</div>

@Html.Partial("_ProductFormPartial")

@section Scripts {
    <script>
        $(document).ready(function () {
            let categories = [];
            let editingProductId = null;

            // khởi tạo modal instance khi cần
            function getModal() {
                const modalEl = document.getElementById('productModal');
                return bootstrap.Modal.getInstance(modalEl)
                    || new bootstrap.Modal(modalEl);
            }

            // Load danh mục
            function loadCategories() {
                $.get('/api/farmer/categories')
                    .done(function (data) {
                        categories = data;
                        populateCategorySelect();
                    })
                    .fail(function (xhr) {
                        console.error('Không thể tải danh mục:', xhr);
                        alert('Không thể tải danh mục');
                    });
            }

            // Điền select
            function populateCategorySelect() {
                const select = $('#categoryId');
                select.empty().append('<option value="">-- Chọn danh mục --</option>');
                categories.forEach(cat => {
                    select.append(
                        `<option value="${cat.categoryId}">${cat.categoryName}</option>`
                    );
                });
            }

            // Load & render sản phẩm
            function loadProducts() {
                $.get('/api/farmer/products')
                    .done(renderProductTable)
                    .fail(xhr => {
                        console.error('Lỗi tải sản phẩm:', xhr);
                        alert('Không thể tải sản phẩm');
                    });
            }

            // Vẽ bảng
            function renderProductTable(products) {
                const tbody = $('#productTableBody').empty();
                if (!products.length) {
                    tbody.append('<tr><td colspan="9" class="text-center">Chưa có sản phẩm</td></tr>');
                    return;
                }

                products.forEach(p => {
                    const imgHtml = p.imageUrls && p.imageUrls.length
                        ? `<img src="${p.imageUrls[0]}" style="width:50px;height:50px;object-fit:cover" class="rounded">`
                        : '<span class="text-muted">Không có ảnh</span>';

                    const $row = $(`
                        <tr>
                            <td>${imgHtml}</td>
                            <td>${p.productName}</td>
                            <td>${p.categoryName}</td>
                            <td>${new Intl.NumberFormat('vi-VN').format(p.price)}</td>
                            <td>${p.quantityAvailable}</td>
                            <td>${p.unit || '-'}</td>
                            <td title="${(p.description || '')}">
                                ${(p.description || '').substring(0, 50)}${(p.description || '').length > 50 ? '…' : ''}
                            </td>
                            <td>${new Date(p.createdAt).toLocaleDateString('vi-VN')}</td>
                            <td>
                                <button class="btn btn-sm btn-warning btn-edit me-1" data-id="${p.productId}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger btn-delete" data-id="${p.productId}" data-name="${p.productName}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                    tbody.append($row);
                });
            }

            // Mở modal Create/Edit
            function openModal(mode, product) {
                editingProductId = mode === 'edit' ? product.productId : null;

                // Reset form
                const $form = $('#productForm')[0];
                $form.reset();
                populateCategorySelect();
                $('#currentImages').empty().toggle(mode === 'edit');
                $('#productImages').prop('required', mode === 'create');

                // Tiêu đề
                $('#productModalLabel')
                    .text(mode === 'create' ? 'Thêm sản phẩm mới' : 'Sửa sản phẩm');

                if (mode === 'edit') {
                    // điền giá trị
                    $('#productName').val(product.productName);
                    $('#categoryId').val(product.categoryId);
                    $('#price').val(product.price);
                    $('#quantityAvailable').val(product.quantityAvailable);
                    $('#unit').val(product.unit || '');
                    $('#description').val(product.description || '');

                    // hiển thị ảnh cũ
                    const $cur = $('#currentImages').empty();
                    (product.imageUrls || []).forEach(url => {
                        $cur.append(`
                            <img src="${url}"
                                 style="width:80px;height:80px;object-fit:cover"
                                 class="me-2 mb-2 border rounded">
                        `);
                    });
                }

                // show modal
                getModal().show();
            }

            // Tạo mới
            function createProduct() {
                const formData = new FormData($('#productForm')[0]);
                $.ajax({
                    url: '/api/farmer/products',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                })
                    .done(res => {
                        getModal().hide(); 
                        loadProducts();
                    })
                    .fail(xhr => {
                        console.error('Create error:', xhr);
                        alert('Lỗi khi thêm sản phẩm');
                    });
            }

            // Lấy dữ liệu để sửa
            function editProduct(id) {
                $.get(`/api/farmer/products/${id}`)
                    .done(product => openModal('edit', product))
                    .fail(xhr => {
                        console.error('Edit load error:', xhr);
                        alert('Không thể tải thông tin sản phẩm');
                    });
            }

            // Cập nhật
            function updateProduct() {
                const formData = new FormData($('#productForm')[0]);
                $.ajax({
                    url: `/api/farmer/products/${editingProductId}`,
                    type: 'PUT',
                    data: formData,
                    processData: false,
                    contentType: false,
                })
                    .done(res => {
                        getModal().hide();
                        // alert('Cập nhật thành công');
                        loadProducts();
                    })
                    .fail(xhr => {
                        console.error('Update error:', xhr);
                        alert('Lỗi khi cập nhật sản phẩm');
                    });
            }

            // Xóa
            function deleteProduct(id, name) {
                if (!confirm(`Xóa sản phẩm "${name}"?`)) return;
                $.ajax({
                    url: `/api/farmer/products/${id}`,
                    type: 'DELETE'
                })
                    .done(res => {
                        
                        loadProducts();
                    })
                    .fail(xhr => {
                        console.error('Delete error:', xhr);
                        alert('Lỗi khi xóa sản phẩm');
                    });
            }

            // Event binding
            $('#btnCreate').click(() => openModal('create'));
            $('#productForm').submit(function (e) {
                e.preventDefault();
                editingProductId ? updateProduct() : createProduct();
            });
            $(document).on('click', '.btn-edit', function () {
                editProduct($(this).data('id'));
            });
            $(document).on('click', '.btn-delete', function () {
                deleteProduct($(this).data('id'), $(this).data('name'));
            });

            // Kick off
            loadCategories();
            loadProducts();

            // Đổi tên hàm showForm thành openProductForm
            window.openProductForm = function (mode, id) {
                if (mode === 'create') {
                    openModal('create');
                } else {
                    editProduct(id);
                }
            };

            // Đổi tên hàm del thành deleteProductItem
            window.deleteProductItem = function (id) {
                const name = document
                    .querySelector(`button.btn-delete[data-id="${id}"]`)
                    ?.getAttribute('data-name') || '';
                deleteProduct(id, name);
            };

            // Thêm log để kiểm tra
            console.log('farmer-product.js loaded, openProductForm defined:', typeof window.openProductForm);
            console.log('farmer-product.js loaded, deleteProductItem defined:', typeof window.deleteProductItem);
        });
    </script>
}