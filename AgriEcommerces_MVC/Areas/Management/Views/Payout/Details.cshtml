@model AgriEcommerces_MVC.Models.PayoutRequest
@{
    ViewData["Title"] = "Chi tiết yêu cầu rút tiền";

    // Parse JSON bankDetails
    dynamic bankInfo = null;
    if (!string.IsNullOrEmpty(Model.BankDetails))
    {
        bankInfo = Newtonsoft.Json.JsonConvert.DeserializeObject<dynamic>(Model.BankDetails);
    }
}

<div class="container-fluid">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-area="Management" asp-controller="Payout" asp-action="Index">Quản lý rút tiền</a></li>
            <li class="breadcrumb-item active" aria-current="page">chi tiết</li>
        </ol>
    </nav>
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header badge bg-warning">  
                    <h4>Thông tin yêu cầu #@Model.PayoutRequestId</h4>
                </div>
                <div class="card-body">
                    <p><strong>Tên shop:</strong> @Model.Farmer?.fullname</p>
                    <p><strong>Số tiền:</strong> <span class="fw-bold fs-4" style="-webkit-text-fill-color:orange">@Model.Amount.ToString("N0") VNĐ</span></p>
                    <p><strong>Ngày tạo:</strong> @Model.RequestDate</p>
                    <p>
                        <strong>Trạng thái:</strong>
                        @if (Model.Status == "Pending")
                        {
                            <span class="badge bg-warning text-black">Chờ duyệt</span>
                        }
                        else if (Model.Status == "Completed")
                        {

                            <span class="badge bg-success text-black">Đã chuyển</span>
                        }
                        else
                        {

                            <span class="badge bg-danger text-black">Đã từ chối</span>
                        }
                    </p>

                    <hr />
                    <h5>Thông tin ngân hàng người bán:</h5>
                    <ul>
                        <li>Ngân hàng: <strong>@bankInfo?.BankCode</strong></li>
                        <li>Số tài khoản: <strong>@bankInfo?.AccountNumber</strong></li>
                        <li>Chủ tài khoản: <strong>@bankInfo?.AccountName</strong></li>
                    </ul>
                </div>
            </div>
            <br />
            <div class="alert alert-warning text-start" role="alert">
                <h6 class="alert-heading fw-bold"><i class="fas fa-exclamation-triangle"></i> LƯU Ý QUAN TRỌNG:</h6>
                <p class="mb-0 small">
                    Trước khi bấm chuyển tiền trên điện thoại, vui lòng kiểm tra tên người nhận trên App ngân hàng có khớp với tên dưới đây không:
                </p>
                
                <hr>
                <div class="text-center">
                    <span class="text-muted">Tên người bán khai báo:</span><br />
                    <span class="fs-5 fw-bold text-uppercase text-primary">@bankInfo.AccountName</span>
                </div>
                <p class="mb-0 small">
                    <strong>Nếu KHÔNG KHỚP TÊN, VUI LÒNG KHÔNG CHUYỂN TIỀN!</strong> <br />Hãy bấm nút
                    <strong>"SAI TÊN / TỪ CHỐI"</strong> để từ chối yêu cầu rút tiền này.
                </p>
            </div>
        </div>

        <div class="col-md-6">
            @if (Model.Status == "Pending")
            {
                <div class="card shadow border-primary">
                    <div class="card-header bg-info text-white text-center">
                        <h5 class="mb-0"><i class="fas fa-qrcode"></i> QUÉT MÃ ĐỂ CHUYỂN TIỀN</h5>
                    </div>
                    <div class="card-body text-center">
                        @if (bankInfo != null)
                        {
                                string qrUrl = $"https://img.vietqr.io/image/{bankInfo.BankCode}-{bankInfo.AccountNumber}-compact2.png";
                                qrUrl += $"?amount={Model.Amount}";
                                qrUrl += $"&addInfo=Thanh toan rut tien Farmer {Model.FarmerId}";
                                qrUrl += $"&accountName={bankInfo.AccountName}";
                            
                            <img src="@qrUrl" class="img-fluid mb-3" style="max-width: 300px; border: 2px solid #0d6efd; border-radius: 8px;" alt="VietQR Code" />
                        }
                        else
                        {
                            <div class="alert alert-danger">Dữ liệu ngân hàng bị lỗi.</div>
                        }

                        <hr />
                        <form asp-action="Approve" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.PayoutRequestId" />
                    
                            <div class="mb-3 text-start">
                                <label class="form-label fw-bold">Nhập mã giao dịch (FT...):</label>
                                <input type="text" name="transactionCode" class="form-control" required placeholder="Nhập mã sau khi chuyển thành công">
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success ">
                                    <i class="fas fa-check-circle"></i> ĐÃ CHUYỂN ĐÚNG & DUYỆT
                                </button>
                        
                                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#rejectModal">
                                    <i class="fas fa-times-circle"></i> SAI TÊN / TỪ CHỐI
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            }
        </div>

        <div class="modal fade" id="rejectModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form asp-action="Reject" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.PayoutRequestId" />
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">Từ chối yêu cầu</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <label class="form-label">Lý do từ chối:</label>
                            <textarea name="reason" class="form-control" rows="3" required>Thông tin ngân hàng không chính xác (Sai tên chủ tài khoản).</textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            <button type="submit" class="btn btn-danger">Xác nhận Từ chối</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>