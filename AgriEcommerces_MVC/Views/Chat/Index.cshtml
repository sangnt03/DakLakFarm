@using AgriEcommerces_MVC.Controllers
@model List<ConversationViewModel>

@{
    ViewData["Title"] = "Tin nhắn của tôi";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var selectedUserId = ViewBag.SelectedUserId as string;
    var selectedProductId = ViewBag.SelectedProductId as int?;
}

<style>
    /* LAYOUT CƠ BẢN */
    .inbox-wrapper {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-top: 20px;
        margin-bottom: 20px;
        height: 600px;
        display: flex;
    }

    /* CỘT TRÁI: DANH SÁCH */
    .inbox-list-panel {
        width: 350px;
        border-right: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
    }

    .inbox-header {
        background: linear-gradient(135deg, #FFC800 0%, #FFB300 100%);
        padding: 15px 20px;
        color: #333;
        flex-shrink: 0;
    }

    .conversation-list {
        list-style: none;
        padding: 0;
        margin: 0;
        overflow-y: auto;
        flex: 1;
    }

    .conversation-item {
        padding: 15px 20px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: background 0.2s;
    }

        .conversation-item:hover {
            background: #fff;
        }

        .conversation-item.active {
            background: #fff;
            border-left: 4px solid #FFC800;
        }

    .conversation-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #FFC800;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        flex-shrink: 0;
    }

    .conversation-info {
        flex: 1;
        min-width: 0;
    }

    .user-name {
        font-weight: 600;
        margin-bottom: 2px;
        color: #333;
    }

    .last-msg {
        font-size: 13px;
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* CỘT PHẢI: KHUNG CHAT */
    .inbox-chat-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
    }

    #chatBoxContainer {
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .empty-state {
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #999;
    }

        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            color: #ddd;
        }


    @@media (max-width: 767px) {
        .inbox-wrapper

    {
        height: calc(100vh - 80px); /* Chiếm gần toàn màn hình */
        margin: 10px;
        border-radius: 0;
    }

    /* Mặc định: Hiện danh sách, ẩn chat */
    .inbox-list-panel {
        width: 100%;
        border-right: none;
    }

    .inbox-chat-panel {
        display: none; /* Ẩn chat panel ban đầu */
        width: 100%;
    }

    /* Khi có class "show-chat" -> Ẩn danh sách, hiện chat */
    .inbox-wrapper.show-chat .inbox-list-panel {
        display: none;
    }

    .inbox-wrapper.show-chat .inbox-chat-panel {
        display: flex;
    }

    /* Điều chỉnh avatar và text */
    .conversation-avatar {
        width: 40px;
        height: 40px;
        font-size: 16px;
    }

    .conversation-item {
        padding: 12px 15px;
    }

    .inbox-header h5 {
        font-size: 18px;
    }

    }

    /* Tablet */
    @@media (min-width: 768px) and (max-width: 991px) {
        .inbox-list-panel

    {
        width: 300px;
    }

    .conversation-avatar {
        width: 40px;
        height: 40px;
    }

    }
</style>

<div class="container">
    <div class="inbox-wrapper" id="inboxWrapper">

        <div class="inbox-list-panel">
            <div class="inbox-header">
                <h5 class="m-0"><i class="fas fa-inbox"></i> Tin nhắn</h5>
            </div>

            @if (Model == null || !Model.Any())
            {
                <div class="p-4 text-center text-muted">
                    <small>Chưa có tin nhắn nào</small>
                </div>
            }
            else
            {
                <ul class="conversation-list">
                    @foreach (var conv in Model)
                    {
                        var activeClass = (conv.UserId == selectedUserId) ? "active" : "";

                        <li class="conversation-item @activeClass"
                            id="conv-@conv.UserId"
                            onclick="loadChatBox('@conv.UserId', @selectedProductId)">

                            <div class="conversation-avatar">
                                @conv.AvatarChar
                            </div>
                            <div class="conversation-info">
                                <div class="d-flex justify-content-between">
                                    <div class="user-name">@conv.UserName</div>
                                    @if (conv.Timestamp.HasValue)
                                    {
                                        <small class="text-muted" style="font-size: 11px;">
                                            @conv.Timestamp.Value.ToString("HH:mm dd/MM")
                                        </small>
                                    }
                                </div>
                                <div class="last-msg">
                                    @(conv.LastMessage ?? "...")
                                </div>
                            </div>
                        </li>
                    }
                </ul>
            }
        </div>

        <div class="inbox-chat-panel">
            <div id="chatBoxContainer">
                <div class="empty-state">
                    <i class="far fa-comments"></i>
                    <p>Chọn một cuộc trò chuyện để bắt đầu</p>
                </div>
            </div>
        </div>

    </div>
</div>

@section Scripts {
    <script>
        const preSelectedUserId = '@selectedUserId';
        const preSelectedProductId = '@selectedProductId';

        $(document).ready(function() {
            if (preSelectedUserId) {
                loadChatBox(preSelectedUserId, preSelectedProductId);
            }
        });

        function loadChatBox(userId, productId) {
            // 1. Highlight mục đang chọn
            $('.conversation-item').removeClass('active');
            $(`#conv-${userId}`).addClass('active');

            // 2. Trên mobile: chuyển sang hiển thị chat
            if (window.innerWidth < 768) {
                $('#inboxWrapper').addClass('show-chat');
            }

            // 3. Hiển thị loading
            $('#chatBoxContainer').html(`
                <div class="empty-state">
                    <div class="spinner-border text-warning" role="status"></div>
                    <p class="mt-2">Đang tải tin nhắn...</p>
                </div>
            `);

            // 4. Load chat box
            const pId = productId ? productId : 0;
            const url = '@Url.Action("GetChatBoxPartial", "Chat")';

            $.get(`${url}?receiverId=${userId}&productId=${pId}`, function(data) {
                $('#chatBoxContainer').html(data);
            })
            .fail(function() {
                $('#chatBoxContainer').html('<p class="text-center mt-5">Lỗi tải tin nhắn.</p>');
            });
        }

        // Hàm quay lại danh sách (gọi từ _ChatBox)
        window.backToConversationList = function() {
            $('#inboxWrapper').removeClass('show-chat');
        };

        var listConnection = new signalR.HubConnectionBuilder()
            .withUrl("/chathub?userType=Customer")
            .withAutomaticReconnect()
            .build();

        listConnection.on("ReceiveMessage", function (data) {
            console.log("📨 List nhận tin:", data);

            // Tìm item trong danh sách dựa vào senderId hoặc receiverId
            var $itemSender = $("#conv-" + data.senderId);
            var $itemReceiver = $("#conv-" + data.receiverId);
            var $targetItem = $itemSender.length ? $itemSender : $itemReceiver;

            if ($targetItem.length > 0) {
                // 1. Cập nhật nội dung tin nhắn cuối
                var content = data.content;
                if(data.productId) content = "[Sản phẩm] " + content;
                $targetItem.find(".last-msg").text(content);

                // 2. Cập nhật thời gian (Format HH:mm dd/MM)
                var date = new Date(data.timestamp);
                var timeStr = date.getHours().toString().padStart(2, '0') + ":" +
                              date.getMinutes().toString().padStart(2, '0') + " " +
                              date.getDate().toString().padStart(2, '0') + "/" +
                              (date.getMonth() + 1).toString().padStart(2, '0');

                $targetItem.find("small.text-muted").text(timeStr);

                // 3. Đưa item lên đầu danh sách
                var $parent = $targetItem.parent();
                $targetItem.prependTo($parent);

                // 4. Làm đậm tin nhắn mới (nếu không phải đang active)
                if (!$targetItem.hasClass('active')) {
                    $targetItem.find(".last-msg").css("font-weight", "bold");
                    $targetItem.find(".user-name").css("color", "#000");
                }
            } else {
                console.log("⚠️ Không tìm thấy conversation item cho:", data.senderId, data.receiverId);
            }
        });

        listConnection.start().then(function() {
            console.log("✅ List SignalR Connected!");
        }).catch(function (err) {
            console.error("❌ List SignalR Error: ", err.toString());
        });
    </script>
}