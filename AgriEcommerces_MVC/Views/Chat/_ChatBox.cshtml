@using AgriEcommerces_MVC.Models.ViewModel
@using System.Security.Claims
@model ChatViewModel

@{
    var currentUserId = Context.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    // Lấy Role hiện tại của người dùng (Customer/Farmer/Admin)
    var currentUserRole = Context.User.FindFirst(ClaimTypes.Role)?.Value ?? "Customer";
}

<input type="hidden" id="hdCurrentUserId" value="@currentUserId" />
<input type="hidden" id="hdCurrentUserRole" value="@currentUserRole" />
<input type="hidden" id="hdReceiverId" value="@Model.ReceiverId" />
<input type="hidden" id="hdProductId" value="@Model.ProductId" />
<input type="hidden" id="hdProductName" value="@Model.ProductName" />

<style>
    .chat-box-body {
        height: 400px;
        overflow-y: auto;
        background: #fdfdfd;
        padding: 15px;
    }

    .message-item {
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
    }

        .message-item.sent {
            align-items: flex-end;
        }

        .message-item.received {
            align-items: flex-start;
        }

    .message-bubble {
        max-width: 75%;
        padding: 8px 12px;
        border-radius: 15px;
        word-wrap: break-word;
    }

    .message-item.sent .message-bubble {
        background: #FFC800;
        color: #333;
        border-bottom-right-radius: 2px;
    }

    .message-item.received .message-bubble {
        background: #eee;
        color: #333;
        border-bottom-left-radius: 2px;
    }

    /* RESPONSIVE cho mobile */
    @@media (max-width: 767px) {
        .chat-box-body {
            height: calc(100vh - 280px); /* Tăng chiều cao trên mobile */
            min-height: 300px;
        }

        .message-bubble {
            max-width: 85%; /* Rộng hơn trên mobile */
        }

        .chat-box-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .chat-box-footer {
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
    }
</style>

<div class="chat-box-header p-3 border-bottom bg-white d-flex justify-content-between align-items-center">
    <div class="flex-grow-1">
        <button class="btn btn-link p-0 me-2 d-md-none" onclick="backToConversationList()" type="button">
            <i class="fas fa-arrow-left"></i>
        </button>
        <h6 class="m-0 font-weight-bold d-inline">@Model.ReceiverName</h6>
        @if (Model.ProductId > 0)
        {
            <div>
                <small class="text-muted"><i class="fas fa-tag"></i> Sản phẩm: <strong>@Model.ProductName</strong></small>
            </div>
        }
    </div>
</div>

<div id="divMessagesList" class="chat-box-body">
    <div class="text-center text-muted mt-5"><i class="fas fa-spinner fa-spin"></i> Đang tải tin nhắn...</div>
</div>

<div class="chat-box-footer p-3 bg-white border-top">
    <div class="input-group">
        <input type="text" id="txtMessageInput" class="form-control" placeholder="Nhập tin nhắn..." autocomplete="off">
        <button class="btn btn-warning" type="button" id="btnSend_Inbox" disabled>
            <i class="fas fa-paper-plane d-none d-md-inline"></i>
            <span class="d-none d-md-inline ms-1">Gửi</span>
            <i class="fas fa-paper-plane d-md-none"></i>
        </button>
    </div>
</div>

<script>
    (function () {
        const userId = $("#hdCurrentUserId").val();
        const userRole = $("#hdCurrentUserRole").val();
        const receiverId = $("#hdReceiverId").val();
        const productId = $("#hdProductId").val();

        let connection = null;

        async function startChat() {
            try {
                if (connection && connection.state !== signalR.HubConnectionState.Disconnected) {
                    await connection.stop();
                }

                // Truyền Dynamic Role vào query string thay vì fix cứng 'Customer'
                connection = new signalR.HubConnectionBuilder()
                    .withUrl("/chathub?userType=" + encodeURIComponent(userRole))
                    .withAutomaticReconnect()
                    .build();

                connection.on("ReceiveMessage", function (data) {
                    appendMessage(data);
                });

                await connection.start();
                $("#btnSend_Inbox").prop("disabled", false);
                loadHistory();

            } catch (err) {
                // Đã bỏ log lỗi
            }
        }

        async function sendMessage() {
            const msg = $("#txtMessageInput").val().trim();
            if (!msg) {
                return;
            }

            const pId = productId ? parseInt(productId) : null;

            try {
                await connection.invoke("SendMessageToUser", receiverId, msg, pId);
                $("#txtMessageInput").val('').focus();
            } catch (err) {
                alert("Lỗi gửi tin nhắn, vui lòng thử lại sau.");
            }
        }

        function appendMessage(data) {
            const sender = String(data.senderId || "");
            const receiver = String(data.receiverId || "");
            const current = String(userId || "");
            const boxReceiver = String(receiverId || "");

            // Logic hiển thị:
            // 1. Tin nhắn mình gửi cho người này
            // 2. Tin nhắn người này gửi cho mình
            const isRelevant =
                (sender === current && receiver === boxReceiver) ||
                (sender === boxReceiver && receiver === current);

            if (!isRelevant) {
                return;
            }

            const isMe = sender === current;
            const time = new Date(data.timestamp).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            const html = `
                <div class="message-item ${isMe ? 'sent' : 'received'}">
                    <div class="message-bubble">
                        ${data.productId ? `<small class="d-block text-muted mb-1">SP #${data.productId}</small>` : ''}
                        <span>${escapeHtml(data.content)}</span>
                    </div>
                    <small class="text-muted mt-1" style="font-size: 10px;">${time}</small>
                </div>`;

            $("#divMessagesList .text-center").remove();
            $("#divMessagesList").append(html);
            scrollToBottom();
        }

        function loadHistory() {
            const url = `/Chat/GetChatHistory?targetUserId=${receiverId}&skip=0&take=50`;

            $.get(url, function(data) {
                $("#divMessagesList").empty();

                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => appendMessage(msg));
                } else {
                    const pName = $("#hdProductName").val();
                    const pId = $("#hdProductId").val();

                    if (pId && pId > 0 && pName) {
                        showWelcomeMessage(pName);
                    } else {
                        $("#divMessagesList").html('<div class="text-center text-muted mt-5">Hãy bắt đầu trò chuyện!</div>');
                    }
                }
            }).fail(function() {
                $("#divMessagesList").html('<div class="text-center text-danger mt-5">Không thể tải lịch sử tin nhắn.</div>');
            });
        }

        function showWelcomeMessage(productName) {
            const time = new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            const html = `
                <div class="message-item received">
                    <div class="message-bubble">
                        <small class="d-block text-muted mb-1" style="font-size: 11px;">Tin nhắn tự động</small>
                        <span>Xin chào, Shop có thể tư vấn gì cho bạn về sản phẩm <b>${escapeHtml(productName)}</b> này không ạ?</span>
                    </div>
                    <small class="text-muted mt-1" style="font-size: 10px;">${time}</small>
                </div>`;

            $("#divMessagesList").append(html);
            scrollToBottom();
        }

        function scrollToBottom() {
            const el = document.getElementById("divMessagesList");
            if(el) el.scrollTop = el.scrollHeight;
        }

        function escapeHtml(text) {
            return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : "";
        }

        // Clean up events cũ để tránh duplicate events nếu view được load lại qua Ajax
        $(document).off('click', '#btnSend_Inbox');
        $(document).off('keypress', '#txtMessageInput');

        $(document).on('click', '#btnSend_Inbox', function(e) {
            e.preventDefault();
            sendMessage();
        });

        $(document).on('keypress', '#txtMessageInput', function(e) {
            if(e.which === 13) {
                e.preventDefault();
                sendMessage();
            }
        });

        startChat();
    })();
</script>