@model AgriEcommerces_MVC.Models.product

@{
    ViewData["Title"] = "Chi tiết sản phẩm";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var images = Model.productimages?.Select(pi => pi.imageurl).ToList() ?? new List<string>();
    if (!images.Any())
    {
        images.Add("~/images/products/noimage.png");
    }
    var mainImage = Url.Content(images.First());

    // Tính toán rating trung bình
    var averageRating = Model.reviews != null && Model.reviews.Any()
        ? Model.reviews.Average(r => r.rating)
        : 0;
    var reviewCount = Model.reviews?.Count() ?? 0;

    // --- LOGIC PHÂN TRANG ĐÁNH GIÁ ---
    int reviewPage = Context.Request.Query.ContainsKey("reviewPage") ? int.Parse(Context.Request.Query["reviewPage"]) : 1;
    int reviewsPageSize = 5; // Hiển thị 5 đánh giá mỗi trang
    var allReviews = Model.reviews?.OrderByDescending(r => r.createdat) ?? Enumerable.Empty<AgriEcommerces_MVC.Models.review>();
    var paginatedReviews = allReviews.Skip((reviewPage - 1) * reviewsPageSize).Take(reviewsPageSize);
    var totalReviewPages = (int)Math.Ceiling(allReviews.Count() / (double)reviewsPageSize);
    // --- KẾT THÚC LOGIC ---
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

@section Styles {
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
        }

        /* === Panel chung cho Ảnh và Thông tin === */
        .product-main-panel {
            background: #fff;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* === PRODUCT GALLERY (Đã xóa nền) === */
        .product-gallery-wrapper {
        }

        .product-gallery {
            position: relative;
            max-width: 450px;
            margin: 0 auto;
        }

        .main-image-container {
            position: relative;
            width: 450px;
            height: 450px;
            overflow: hidden;
            border-radius: 4px;
            background-color: #fff;
            margin-bottom: 12px;
            cursor: zoom-in;
            border: 1px solid #f0f0f0;
        }

            .main-image-container img {
                width: 100%;
                height: 100%;
                object-fit: contain;
                transition: opacity 0.2s ease-in-out;
            }

        .thumbnail-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: #ccc #f5f5f5;
            padding: 4px 0;
        }

            .thumbnail-container::-webkit-scrollbar {
                height: 6px;
            }

            .thumbnail-container::-webkit-scrollbar-track {
                background: #f5f5f5;
            }

            .thumbnail-container::-webkit-scrollbar-thumb {
                background: #ccc;
                border-radius: 3px;
            }

        .thumbnail-item {
            flex: 0 0 84px;
            width: 84px;
            height: 84px;
            cursor: pointer;
            border: 2px solid #eee;
            border-radius: 4px;
            overflow: hidden;
            background: #fff;
            transition: all 0.2s ease;
        }

            .thumbnail-item:hover {
                border-color: #ee4d2d;
            }

            .thumbnail-item.active {
                border-color: #ee4d2d;
            }

            .thumbnail-item img {
                width: 100%;
                height: 100%;
                object-fit: contain;
                padding: 4px;
            }

        /* === PRODUCT INFO PANEL (Đã xóa nền, thêm flex) === */
        .product-info-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* SỬA FONT-SIZE VÀ FONT-WEIGHT */
        .product-title {
            font-size: 26px; /* Tăng kích thước */
            font-weight: 700; /* In đậm */
            line-height: 1.4;
            color: rgba(0,0,0,.87);
            margin-bottom: 12px;
        }

        .product-rating-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #efefef;
            margin-bottom: 15px;
        }

        .rating-score {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rating-number {
            color: #ee4d2d;
            font-size: 16px;
            text-decoration: underline;
            border-right: 1px solid #ccc;
            padding-right: 15px;
        }

        .star-rating {
            display: flex;
            gap: 2px;
        }

            .star-rating .fa-star {
                color: #ffce3d;
                font-size: 14px;
            }

                .star-rating .fa-star.half {
                    color: #ffce3d;
                }

                .star-rating .fa-star.empty {
                    color: #d5d5d5;
                }

        .review-count,
        .sold-count {
            color: rgba(0,0,0,.54);
            border-right: 1px solid #ccc;
            padding-right: 15px;
        }

            .sold-count:last-child {
                border-right: none;
            }

        /* === PRICE SECTION === */
        .price-section {
            background: #fafafa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .price-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .product-price {
            font-size: 30px;
            color: #ee4d2d;
            font-weight: 500;
        }

        .price-unit {
            font-size: 16px;
            color: rgba(0,0,0,.54);
        }

        /* === QUANTITY SECTION === */
        .quantity-section {
            margin-bottom: 25px;
        }

        .section-label {
            color: rgba(0,0,0,.54);
            margin-bottom: 12px;
            font-size: 14px;
        }

        .quantity-wrapper {
            display: flex;
            align-items: center;
            border: 1px solid rgba(0,0,0,.09);
            border-radius: 2px;
            width: fit-content;
        }

            .quantity-wrapper button {
                width: 32px;
                height: 32px;
                border: none;
                background: transparent;
                color: rgba(0,0,0,.54);
                font-size: 18px;
                cursor: pointer;
                transition: background 0.1s;
            }

                .quantity-wrapper button:hover {
                    background: rgba(0,0,0,.02);
                }

                .quantity-wrapper button:disabled {
                    cursor: not-allowed;
                    opacity: 0.5;
                }

            .quantity-wrapper input {
                width: 50px;
                height: 32px;
                border: none;
                border-left: 1px solid rgba(0,0,0,.09);
                border-right: 1px solid rgba(0,0,0,.09);
                text-align: center;
                font-size: 16px;
            }

        /* === ACTION BUTTONS (MODIFIED) === */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: auto;
        }

        .btn-add-cart {
            flex: 1;
            height: 48px;
            border: 1px solid #ffc800;
            background: rgba(255, 200, 0, 0.1);
            color: #e6b400;
            font-size: 16px;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

            .btn-add-cart:hover {
                background: rgba(255, 200, 0, 0.2);
            }

        .btn-buy-now {
            flex: 1;
            height: 48px;
            border: 1px solid #ffc800;
            background: #ffc800;
            color: #333;
            font-size: 16px;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.1s;
        }

            .btn-buy-now:hover {
                background: #e6b400;
                border-color: #e6b400;
            }

        /* === DESCRIPTION PANEL === */
        .product-description-panel {
            background: #fff;
            padding: 25px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .panel-header {
            font-size: 18px;
            color: rgba(0,0,0,.87);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #efefef;
            text-transform: uppercase;
        }

        .product-details {
            margin-bottom: 0;
        }

        .detail-row {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid #efefef;
        }

            .detail-row:last-child {
                border-bottom: none;
            }

        .detail-label {
            color: rgba(0,0,0,.54);
            width: 140px;
            flex-shrink: 0;
        }

        .detail-value {
            color: rgba(0,0,0,.87);
            white-space: pre-wrap;
            line-height: 1.6;
        }


        /* === REVIEWS SECTION === */
        .reviews-panel {
            background: #fff;
            padding: 25px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .reviews-header {
            font-size: 18px;
            color: rgba(0,0,0,.87);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #efefef;
        }

        .review-card {
            padding: 20px 0;
            border-bottom: 1px solid #efefef;
        }

            .review-card:last-child {
                border-bottom: none;
            }

        .reviewer-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .reviewer-avatar {
            width: 40px;
            height: 40px;
            background: #ee4d2d;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 600;
            margin-right: 12px;
        }

        .reviewer-details {
            flex: 1;
        }

        .reviewer-name {
            color: rgba(0,0,0,.87);
            font-weight: 500;
            margin-bottom: 4px;
        }

        .review-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: rgba(0,0,0,.54);
        }

        .comment-text {
            color: rgba(0,0,0,.87);
            line-height: 1.6;
            margin-top: 10px;
        }

        .no-reviews {
            text-align: center;
            padding: 40px;
            color: rgba(0,0,0,.54);
        }

            .no-reviews i {
                font-size: 48px;
                margin-bottom: 15px;
                color: rgba(0,0,0,.26);
            }

        /* === RESPONSIVE === */
        @@media (max-width: 768px) {
            .main-image-container {
                width: 100%;
                height: auto;
                padding-top: 100%;
                position: relative;
            }

                .main-image-container img {
                    position: absolute;
                    top: 0;
                    left: 0;
                }

            .product-gallery {
                max-width: 100%;
            }

            .thumbnail-item {
                flex: 0 0 70px;
                width: 70px;
                height: 70px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .product-info-panel {
                margin-top: 15px;
            }
        }
    </style>
}

@if (TempData["Success"] != null)
{
    <script>
        alert("Đánh giá của bạn đã được gửi thành công!");
    </script>
}

<div class="container mt-3">

    <div class="row">
        <div class="col-12">
            <div class="product-main-panel">
                <div class="row">
                    <div class="col-md-5">
                        <div class="product-gallery-wrapper">
                            <div class="product-gallery">
                                <div class="main-image-container">
                                    <img id="mainImage" src="@mainImage" alt="@Model.productname">
                                </div>

                                @if (images.Count > 0)
                                {
                                    <div class="thumbnail-container">
                                        @for (int i = 0; i < images.Count; i++)
                                        {
                                            <div class="thumbnail-item @(i == 0 ? "active" : "")" data-img-url="@Url.Content(images[i])">
                                                <img src="@Url.Content(images[i])" alt="Thumbnail @(i + 1)">
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="col-md-7 product-info-panel">
                        <h1 class="product-title">@Model.productname</h1>

                        <div class="product-rating-wrapper">
                            <div class="rating-score">
                                <span class="rating-number">@averageRating.ToString("0.0")</span>
                                <div class="star-rating">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= Math.Floor(averageRating))
                                        {
                                            <i class="fas fa-star"></i>
                                        }
                                        else if (i - 0.5 <= averageRating)
                                        {
                                            <i class="fas fa-star-half-alt half"></i>
                                        }
                                        else
                                        {
                                            <i class="far fa-star empty"></i>
                                        }
                                    }
                                </div>
                            </div>
                            <span class="review-count">
                                <strong>@reviewCount</strong> Đánh giá
                            </span>
                            <span class="sold-count">
                                <strong>0</strong> Đã bán
                            </span>
                        </div>

                        <div class="price-section">
                            <div class="price-wrapper">
                                <span class="product-price">@Model.price.ToString("N0")₫</span>
                                <span class="price-unit">/@Model.unit</span>
                            </div>
                        </div>

                        <div class="quantity-section">
                            <div class="section-label">Số lượng</div>
                            <div class="quantity-wrapper">
                                <button type="button" data-type="minus">−</button>
                                <input type="text" class="input-number" value="1" min="1" />
                                <button type="button" data-type="plus">+</button>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn-add-cart" data-id="@Model.productid">
                                <i class="fas fa-cart-plus"></i>
                                Thêm vào giỏ hàng
                            </button>
                            <button class="btn-buy-now">
                                Mua ngay
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> <div class="row mt-3">
        <div class="col-12">
            <div class="product-description-panel">
                <h3 class="panel-header">CHI TIẾT SẢN PHẨM</h3>
                <div class="product-details">
                    @if (Model.category != null)
                    {
                        <div class="detail-row">
                            <div class="detail-label">Danh mục</div>
                            <div class="detail-value">@Model.category.categoryname</div>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Model.description))
                    {
                        <div class="detail-row">
                            <div class="detail-label">Mô tả</div>
                            <div class="detail-value">@Model.description</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div> <div class="row mt-3">
        <div class="col-12">
            <div class="reviews-panel">
                <h3 class="reviews-header">
                    <i class="fas fa-star" style="color: #ffce3d;"></i>
                    ĐÁNH GIÁ SẢN PHẨM
                </h3>

                @if (!paginatedReviews.Any())
                {
                    <div class="no-reviews">
                        <i class="fas fa-comments"></i>
                        <p>Chưa có đánh giá nào</p>
                    </div>
                }
                else
                {
                    @foreach (var review in paginatedReviews)
                    {
                        <div class="review-card">
                            <div class="reviewer-info">
                                <div class="reviewer-avatar">
                                    @if (review.customer != null && !string.IsNullOrEmpty(review.customer.fullname))
                                    {
                                        <span>@review.customer.fullname.Substring(0, 1).ToUpper()</span>
                                    }
                                    else
                                    {
                                        <i class="fas fa-user"></i>
                                    }
                                </div>
                                <div class="reviewer-details">
                                    <div class="reviewer-name">
                                        @(review.customer?.fullname ?? "Khách hàng")
                                    </div>
                                    <div class="review-meta">
                                        <div class="star-rating">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                if (i <= review.rating)
                                                {
                                                    <i class="fas fa-star"></i>
                                                }
                                                else
                                                {
                                                    <i class="far fa-star empty"></i>
                                                }
                                            }
                                        </div>
                                        <span>@review.createdat?.ToString("dd/MM/yyyy HH:mm")</span>
                                    </div>
                                </div>
                            </div>
                            @if (!string.IsNullOrEmpty(review.comment))
                            {
                                <div class="comment-text">@review.comment</div>
                            }
                        </div>
                    }
                }

                @if (totalReviewPages > 1)
                {
                    <nav aria-label="Review pagination">
                        <ul class="pagination justify-content-center mt-4">
                            <li class="page-item @(reviewPage == 1 ? "disabled" : "")">
                                <a class="page-link" href="@Url.Action("Details", new { id = Model.productid, reviewPage = reviewPage - 1 })">Previous</a>
                            </li>

                            @for (int i = 1; i <= totalReviewPages; i++)
                            {
                                <li class="page-item @(i == reviewPage ? "active" : "")">
                                    <a class="page-link" href="@Url.Action("Details", new { id = Model.productid, reviewPage = i })">@i</a>
                                </li>
                            }

                            <li class="page-item @(reviewPage == totalReviewPages ? "disabled" : "")">
                                <a class="page-link" href="@Url.Action("Details", new { id = Model.productid, reviewPage = reviewPage + 1 })">Next</a>
                            </li>
                        </ul>
                    </nav>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // === CÁC HÀM HỖ TRỢ ===

        function handleUnauthorized() {
            if (confirm('Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng! Bạn có muốn đến trang đăng nhập không?')) {
                const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);
                window.location.href = '/Account/Login?returnUrl=' + returnUrl;
            }
        }

                // Hàm gọi API với xử lý authentication VÀ hiển thị lỗi chi tiết
        async function fetchWithAuth(url) {
            try {
                const resp = await fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (resp.status === 401) {
                    handleUnauthorized();
                    return null;
                }

                // --- ĐOẠN SỬA ĐỔI ---
                if (!resp.ok) {
                    // Lấy nội dung lỗi từ Controller (BadRequest)
                    const errorMsg = await resp.text();
                    alert(errorMsg); // Hiển thị: "Kho chỉ còn 10 sản phẩm..."
                    return null;
                }
                // --------------------

                return await resp.text();
            } catch (error) {
                console.error('Lỗi kết nối:', error);
                alert('Không thể kết nối đến server!');
                return null;
            }
        }

        // === BỘ LẮNG NGHE SỰ KIỆN ===

        document.addEventListener('DOMContentLoaded', () => {

            // 1) Xử lý Gallery ảnh (của trang Details)
            const mainImage = document.getElementById('mainImage');
            const thumbnails = document.querySelectorAll('.thumbnail-item');
            thumbnails.forEach(thumb => {
                const changeImage = () => {
                    const newSrc = thumb.getAttribute('data-img-url');
                    if (mainImage.src !== newSrc) {
                        mainImage.style.opacity = '0.7';
                        setTimeout(() => {
                            mainImage.src = newSrc;
                            mainImage.style.opacity = '1';
                        }, 100);
                        thumbnails.forEach(t => t.classList.remove('active'));
                        thumb.classList.add('active');
                    }
                };
                thumb.addEventListener('click', changeImage);
                thumb.addEventListener('mouseenter', changeImage);
            });


            // 2) BỘ LẮNG NGHE CLICK TOÀN TRANG (Event Delegation)
            document.body.addEventListener('click', async e => {

                // Nút +/- TRÊN TRANG CHI TIẾT
                const minusOrPlus = e.target.closest('button[data-type]');
                if (minusOrPlus && !minusOrPlus.classList.contains('qty-btn')) {
                    const wrapper = minusOrPlus.closest('.quantity-wrapper');
                    const input = wrapper.querySelector('input.input-number');
                    let value = parseInt(input.value) || 1;

                    if (minusOrPlus.getAttribute('data-type') === 'plus') {
                        value++;
                    } else if (value > 1) {
                        value--;
                    }
                    input.value = value;
                    return;
                }

                // Nút THÊM GIỎ HÀNG (của trang Details)
                const addBtn = e.target.closest('.btn-add-cart');
                if (addBtn) {
                    const id = addBtn.getAttribute('data-id');
                    const input = document.querySelector('.quantity-wrapper input');
                    const qty = parseInt(input.value) || 1;

                    const originalHtml = addBtn.innerHTML;
                    addBtn.disabled = true;
                    addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';

                    const url = '@Url.Action("AddAjax", "Cart")';
                    const html = await fetchWithAuth(`${url}?id=${id}&qty=${qty}`);

                    if (html) {
                        const offcanvasBody = document.getElementById('offcanvasCartBody');
                        if (offcanvasBody) {
                            offcanvasBody.innerHTML = html;
                            new bootstrap.Offcanvas(document.getElementById('offcanvasCart')).show();
                        } else {
                            alert('Đã thêm sản phẩm vào giỏ hàng thành công!');
                        }
                    }

                    addBtn.innerHTML = originalHtml;
                    addBtn.disabled = false;
                    return;
                }

                // 3) Nút +/- TRONG GIỎ HÀNG (Offcanvas)
                const qtyBtn = e.target.closest('.qty-btn');
                if (qtyBtn) {
                    e.preventDefault();
                    const id = qtyBtn.getAttribute('data-id');
                    const action = qtyBtn.getAttribute('data-action');
                    const li = qtyBtn.closest('li');
                    const span = li.querySelector('.qty-value');
                    let qty = parseInt(span.textContent, 10) || 0;
                    qty = (action === 'plus' ? qty + 1 : qty - 1);
                    if (qty < 0) qty = 0;

                    const updateUrl = '@Url.Action("UpdateAjax", "Cart")';
                    const html = await fetchWithAuth(`${updateUrl}?id=${id}&qty=${qty}`);
                    if (!html) return;

                    const offcanvasBody = document.getElementById('offcanvasCartBody');
                    if (offcanvasBody) {
                        offcanvasBody.innerHTML = html;
                    }
                    return;
                }

                // 4) Nút XÓA TRONG GIỎ HÀNG (Offcanvas)
                const remBtn = e.target.closest('.remove-btn');
                if (remBtn) {
                    e.preventDefault();
                    if (!confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
                        return;
                    }

                    const id = remBtn.getAttribute('data-id');
                    const updateUrl = '@Url.Action("UpdateAjax", "Cart")';
                    const html = await fetchWithAuth(`${updateUrl}?id=${id}&qty=0`);
                    if (!html) return;

                    const offcanvasBody = document.getElementById('offcanvasCartBody');
                    if (offcanvasBody) {
                        offcanvasBody.innerHTML = html;
                    }
                    return;
                }

            }); // Hết document.body.addEventListener
        }); // Hết DOMContentLoaded
    </script>
}