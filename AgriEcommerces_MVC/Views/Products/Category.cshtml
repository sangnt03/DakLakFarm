@model IEnumerable<AgriEcommerces_MVC.Models.product>
@{
    ViewData["Title"] = "Sản phẩm theo nhóm";
    // Lấy từ controller
    var categories = ViewBag.Categories as List<AgriEcommerces_MVC.Models.category>;
    int? selectedId = ViewBag.CurrentCategoryId as int?;
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<section class="py-5">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">

                <!-- Header với <select> -->
                <div class="mb-4 d-flex justify-content-between align-items-center border-bottom pb-3">
                    <h3>@ViewData["Title"]</h3>

                    <select class="form-select w-auto"
                            onchange="location = this.value;">
                        @* All *@
                        @if (selectedId == null)
                        {
                            <option value="@Url.Action("Index","Products")" selected>All</option>
                        }
                        else
                        {
                            <option value="@Url.Action("Index","Products")">All</option>
                        }

                        @* Các category động *@
                        @foreach (var c in categories)
                        {
                            if (c.categoryid == selectedId)
                            {
                                <option value="@Url.Action("Category","Products", new { id = c.categoryid })"
                                        selected>
                                    @c.categoryname
                                </option>
                            }
                            else
                            {
                                <option value="@Url.Action("Category","Products", new { id = c.categoryid })">
                                    @c.categoryname
                                </option>
                            }
                        }
                    </select>
                </div>

                <!-- Tabs content -->
                <style>
                    /* Đặt chiều cao cố định cho figure (hoặc theo tỷ lệ bạn muốn) */
                    .product-item figure {
                        width: 100%;
                        height: 200px; /* Bạn có thể thay đổi chiều cao này */
                        overflow: hidden;
                        margin: 0;
                    }
                        /* Cho img phủ full figure và crop nếu lệch tỉ lệ */
                        .product-item figure img {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                            display: block;
                        }
                </style>
                <!-- Grid sản phẩm -->
                <div class="tab-content" id="nav-tabContent">
                    <!-- ALL products -->
                    <div class="tab-pane fade show active"
                         id="nav-all"
                         role="tabpanel"
                         aria-labelledby="nav-all-tab">

                        <div class="product-grid row
                                        row-cols-1
                                        row-cols-sm-2
                                        row-cols-md-3
                                        row-cols-lg-4
                                        row-cols-xl-5">

                            @foreach (var p in Model)
                            {
                                var imgRaw = p.productimages.FirstOrDefault()?.imageurl;
                                var thumb = !string.IsNullOrEmpty(imgRaw)
                                ? Url.Content(imgRaw)
                                : Url.Content("~/images/products/banana.png");
                                <div class="col">
                                    <div class="product-item position-relative">
                                        <!-- wishlist icon -->
                                        @* <a href="#" class="btn-wishlist">
                                            <svg width="24" height="24">
                                                <use xlink:href="#heart"></use>
                                            </svg>
                                        </a> *@

                                        <figure>
                                            <a asp-controller="Products"
                                               asp-action="Details"
                                               asp-route-id="@p.productid"
                                               title="@p.productname">
                                                <img src="@thumb"
                                                     class="tab-image"
                                                     alt="@p.productname" />
                                            </a>
                                        </figure>

                                        <h3>@p.productname</h3>

                                        <span class="rating">
                                            @{
                                                double avgRating = 0.0;
                                                int totalReviews = 0;
                                                if (p.reviews != null && p.reviews.Any())
                                                {
                                                    totalReviews = p.reviews.Count();
                                                    avgRating = p.reviews.Average(r => r.rating);
                                                }

                                                int fullStars = (int)Math.Floor(avgRating);
                                                bool hasHalfStar = false;
                                                if ((avgRating - fullStars) >= 0.5)
                                                {
                                                    hasHalfStar = true;
                                                }
                                                int emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                                            }

                                            <div class="mb-2">
                                                <span class="rating">
                                                    @* Vẽ full stars *@
                                                    @for (int i = 0; i < fullStars; i++)
                                                    {
                                                        <i class="fas fa-star text-primary"></i>
                                                    }
                                                    @* Vẽ half star nếu có *@
                                                    @if (hasHalfStar)
                                                    {
                                                        <i class="fas fa-star-half-alt text-primary"></i>
                                                    }
                                                    @* Vẽ empty stars *@
                                                    @for (int i = 0; i < emptyStars; i++)
                                                    {
                                                        <i class="far fa-star text-muted"></i>
                                                    }
                                                </span>

                                                @* Hiển thị số đánh giá (tuỳ chọn) và điểm trung bình 1 chữ số thập phân *@
                                                @if (totalReviews > 0)
                                                {
                                                    <small class="text-muted ms-1">
                                                        <span class="fw-bold">@avgRating.ToString("0.0")<space>⭐</space></span>
                                                    </small>

                                                }
                                                else
                                                {
                                                    <small class="text-muted ms-1">(Chưa có đánh giá)</small>
                                                }
                                            </div>
                                        </span>
                                        <span class="price">@p.price.ToString("N0") VNĐ/@p.unit</span>

                                        <div class="d-flex align-items-center justify-content-between mt-3">
                                            <div class="d-flex align-items-center quantity-wrapper">
                                                <button type="button"
                                                        class="btn btn-outline-secondary p-0 d-flex justify-content-center align-items-center"
                                                        data-type="minus"
                                                        style="width:32px; height:32px;">
                                                    −
                                                </button>
                                                <input type="text"
                                                       class="form-control text-center mx-2 input-number"
                                                       value="1"
                                                       min="1"
                                                       style="width:48px; padding:0.25rem 0;" />
                                                <button type="button"
                                                        class="btn btn-outline-secondary p-0 d-flex justify-content-center align-items-center"
                                                        data-type="plus"
                                                        style="width:32px; height:32px;">
                                                    +
                                                </button>
                                            </div>
                                            <button class="btn btn-sm btn-outline-primary w-100 add-to-cart"
                                                    data-id="@p.productid">
                                                Add to Cart
                                            </button>
                                        </div>

                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        // 1. Hàm xử lý khi chưa đăng nhập
        function handleUnauthorized() {
            if(confirm('Vui lòng đăng nhập để mua hàng. Bạn có muốn đến trang đăng nhập ngay không?')){
                 const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);
                 window.location.href = '/Account/Login?returnUrl=' + returnUrl;
            }
        }

        // 2. Hàm gọi API với xử lý lỗi chi tiết (Hiển thị thông báo hết hàng từ Controller)
        async function fetchWithAuth(url) {
            try {
                const resp = await fetch(url, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });

                if (resp.status === 401) {
                    handleUnauthorized();
                    return null;
                }

                // Nếu Server trả về lỗi (ví dụ: Kho không đủ hàng)
                if (!resp.ok) {
                    const errorMsg = await resp.text();
                    alert(errorMsg); // Hiển thị alert: "Kho chỉ còn 10 sản phẩm..."
                    return null;
                }

                return await resp.text();
            } catch (error) {
                console.error('Lỗi kết nối:', error);
                alert('Không thể kết nối đến server!');
                return null;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {

            // --- SỰ KIỆN 1: Xử lý khi người dùng TỰ NHẬP SỐ (Change) ---
            document.body.addEventListener('change', e => {
                if (e.target.classList.contains('input-number')) {
                    let val = parseInt(e.target.value) || 1;
                    // Không cho nhập số âm hoặc 0
                    if (val < 1) val = 1;
                    e.target.value = val;
                }
            });

            // --- SỰ KIỆN 2: Xử lý CLICK (Nút +/-, Add to Cart, Xóa...) ---
            document.body.addEventListener('click', async e => {
                const minusOrPlus = e.target.closest('button[data-type]');
                const addBtn = e.target.closest('.add-to-cart');
                const qtyBtn = e.target.closest('.qty-btn'); // Nút +/- trong Offcanvas Cart
                const remBtn = e.target.closest('.remove-btn'); // Nút xóa trong Offcanvas

                // A) Xử lý nút +/- ở danh sách sản phẩm
                if (minusOrPlus && !minusOrPlus.classList.contains('qty-btn')) {
                    e.preventDefault();
                    const wrapper = minusOrPlus.closest('.quantity-wrapper');
                    // Tìm input (lúc này đã bỏ readonly)
                    const input = wrapper.querySelector('input.input-number');

                    let v = parseInt(input.value, 10) || 0;
                    if (minusOrPlus.getAttribute('data-type') === 'plus') v++;
                    else if (v > 1) v--; // Chỉ trừ khi > 1

                    input.value = v < 1 ? 1 : v;
                    return;
                }

                // B) Xử lý nút "Add to Cart"
                if (addBtn) {
                    e.preventDefault();
                    const id = addBtn.getAttribute('data-id');
                    const wrapper = addBtn.closest('.product-item');

                    // Lấy giá trị từ ô input (người dùng có thể đã nhập tay số 100)
                    const input = wrapper.querySelector('input.input-number');
                    let qty = parseInt(input.value, 10);
                    if (isNaN(qty) || qty < 1) qty = 1;

                    // Gọi API thêm vào giỏ
                    const url = '@Url.Action("AddAjax", "Cart")';
                    const html = await fetchWithAuth(`${url}?id=${id}&qty=${qty}`);

                    // Nếu html null nghĩa là lỗi (hết hàng hoặc chưa login), dừng lại
                    if (!html) return;

                    // Cập nhật giao diện giỏ hàng
                    const offcanvasBody = document.getElementById('offcanvasCartBody');
                    if (offcanvasBody) {
                        offcanvasBody.innerHTML = html;
                        new bootstrap.Offcanvas(document.getElementById('offcanvasCart')).show();
                    }
                    return;
                }

                // C) Xử lý nút +/- TRONG Offcanvas Cart (nếu có hiển thị ở trang này)
                if (qtyBtn) {
                    e.preventDefault();
                    const id = qtyBtn.getAttribute('data-id');
                    const action = qtyBtn.getAttribute('data-action');
                    const li = qtyBtn.closest('li');
                    const span = li.querySelector('.qty-value'); // Hoặc input nếu bạn đã đổi trong _CartBody

                    // Logic lấy số lượng hiện tại (xử lý cả trường hợp span hoặc input)
                    let currentQty = 0;
                    if(span.tagName === 'INPUT') currentQty = parseInt(span.value, 10);
                    else currentQty = parseInt(span.textContent, 10);

                    let newQty = (action === 'plus' ? currentQty + 1 : currentQty - 1);
                    if (newQty < 1) newQty = 1;

                    const updateUrl = '@Url.Action("UpdateAjax", "Cart")';
                    const html = await fetchWithAuth(`${updateUrl}?id=${id}&qty=${newQty}`);

                    if (!html) return; // Lỗi kho -> không cập nhật

                    const offcanvasBody = document.getElementById('offcanvasCartBody');
                    if (offcanvasBody) offcanvasBody.innerHTML = html;
                    return;
                }

                // D) Xử lý nút Xóa trong Offcanvas
                if (remBtn) {
                    e.preventDefault();
                    if (!confirm('Bạn có chắc muốn xóa sản phẩm này?')) return;

                    const id = remBtn.getAttribute('data-id');
                    const updateUrl = '@Url.Action("UpdateAjax", "Cart")';
                    const html = await fetchWithAuth(`${updateUrl}?id=${id}&qty=0`);

                    if (!html) return;

                    const offcanvasBody = document.getElementById('offcanvasCartBody');
                    if (offcanvasBody) offcanvasBody.innerHTML = html;
                }
            });
        });
    </script>
}