@model IEnumerable<AgriEcommerces_MVC.Models.product>
@{
    ViewData["Title"] = "Sản phẩm theo nhóm";
    // Lấy từ controller
    var categories = ViewBag.Categories as List<AgriEcommerces_MVC.Models.category>;
    int? selectedId = ViewBag.CurrentCategoryId as int?;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<section class="py-5">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">

                <!-- Header với <select> -->
                <div class="mb-4 d-flex justify-content-between align-items-center border-bottom pb-3">
                    <h3>@ViewData["Title"]</h3>

                    <select class="form-select w-auto"
                            onchange="location = this.value;">
                        @* All *@
                        @if (selectedId == null)
                        {
                            <option value="@Url.Action("Index","Products")" selected>All</option>
                        }
                        else
                        {
                            <option value="@Url.Action("Index","Products")">All</option>
                        }

                        @* Các category động *@
                        @foreach (var c in categories)
                        {
                            if (c.categoryid == selectedId)
                            {
                                <option value="@Url.Action("Category","Products", new { id = c.categoryid })"
                                        selected>
                                    @c.categoryname
                                </option>
                            }
                            else
                            {
                                <option value="@Url.Action("Category","Products", new { id = c.categoryid })">
                                    @c.categoryname
                                </option>
                            }
                        }
                    </select>
                </div>

                <!-- Tabs content -->
                <style>
                    /* Đặt chiều cao cố định cho figure (hoặc theo tỷ lệ bạn muốn) */
                    .product-item figure {
                        width: 100%;
                        height: 200px; /* Bạn có thể thay đổi chiều cao này */
                        overflow: hidden;
                        margin: 0;
                    }
                        /* Cho img phủ full figure và crop nếu lệch tỉ lệ */
                        .product-item figure img {
                            width: 100%;
                            height: 100%;
                            object-fit: cover;
                            display: block;
                        }
                </style>
                <!-- Grid sản phẩm -->
                <div class="tab-content" id="nav-tabContent">
                    <!-- ALL products -->
                    <div class="tab-pane fade show active"
                         id="nav-all"
                         role="tabpanel"
                         aria-labelledby="nav-all-tab">

                        <div class="product-grid row
                                        row-cols-1
                                        row-cols-sm-2
                                        row-cols-md-3
                                        row-cols-lg-4
                                        row-cols-xl-5">

                            @foreach (var p in Model)
                            {
                                var imgRaw = p.productimages.FirstOrDefault()?.imageurl;
                                var thumb = !string.IsNullOrEmpty(imgRaw)
                                ? Url.Content(imgRaw)
                                : Url.Content("~/images/products/banana.png");
                                <div class="col">
                                    <div class="product-item position-relative">
                                        <!-- wishlist icon -->
                                        @* <a href="#" class="btn-wishlist">
                                            <svg width="24" height="24">
                                                <use xlink:href="#heart"></use>
                                            </svg>
                                        </a> *@

                                        <figure>
                                            <a asp-controller="Products"
                                               asp-action="Details"
                                               asp-route-id="@p.productid"
                                               title="@p.productname">
                                                <img src="@thumb"
                                                     class="tab-image"
                                                     alt="@p.productname" />
                                            </a>
                                        </figure>

                                        <h3>@p.productname</h3>

                                        <span class="rating">
                                            <svg width="24" height="24" class="text-primary">
                                                <use xlink:href="~/favicon.ico"></use>
                                            </svg>
                                        </span>
                                        <span class="price">@p.price.ToString("N3") VNĐ/@p.unit</span>

                                        <div class="d-flex align-items-center justify-content-between mt-3">
                                            <div class="d-flex align-items-center quantity-wrapper">
                                                <button type="button"
                                                        class="btn btn-outline-secondary p-0 d-flex justify-content-center align-items-center"
                                                        data-type="minus"
                                                        style="width:32px; height:32px;">
                                                    −
                                                </button>
                                                <input type="text"
                                                       class="form-control text-center mx-2 input-number"
                                                       value="1"
                                                       readonly
                                                       style="width:48px; padding:0.25rem 0;" />
                                                <button type="button"
                                                        class="btn btn-outline-secondary p-0 d-flex justify-content-center align-items-center"
                                                        data-type="plus"
                                                        style="width:32px; height:32px;">
                                                    +
                                                </button>
                                            </div>
                                            <button class="btn btn-sm btn-outline-primary w-100 add-to-cart"
                                                    data-id="@p.productid">
                                                Add to Cart
                                            </button>
                                        </div>

                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', async e => {
                const minusOrPlus = e.target.closest('button[data-type]');
                const addBtn = e.target.closest('.add-to-cart');

                // 1) Xử lý + / − trong product list
                if (minusOrPlus && !minusOrPlus.classList.contains('qty-btn')) {
                    // là nút trên trang Products, data-type="minus" hoặc "plus"
                    e.preventDefault();
                    const wrapper = minusOrPlus.closest('.quantity-wrapper');
                    const input = wrapper.querySelector('input.input-number');
                    let v = parseInt(input.value, 10) || 0;
                    if (minusOrPlus.getAttribute('data-type') === 'plus') v++;
                    else if (v > 1) v--;
                    input.value = v < 1 ? 1 : v;
                    return;
                }

                // 2) Xử lý Add to Cart
                if (addBtn) {
                    e.preventDefault();
                    const id = addBtn.getAttribute('data-id');
                    const wrapper = addBtn.closest('.product-item');
                    const input = wrapper.querySelector('input.input-number');
                    let qty = parseInt(input.value, 10);
                    if (isNaN(qty) || qty < 1) qty = 1;

                    const url = '@Url.Action("AddAjax", "Cart")';
                    const resp = await fetch(`${url}?id=${id}&qty=${qty}`);
                    if (!resp.ok) return console.error('AddAjax lỗi', resp.status);
                    const html = await resp.text();

                    document.getElementById('offcanvasCartBody').innerHTML = html;
                    new bootstrap.Offcanvas(document.getElementById('offcanvasCart')).show();
                    return;
                }

                // 3) Các nút trong offcanvas (qty-btn, remove-btn) vẫn như cũ...
                const qtyBtn = e.target.closest('.qty-btn');
                if (qtyBtn) {
                    e.preventDefault();
                    const id = qtyBtn.getAttribute('data-id');
                    const action = qtyBtn.getAttribute('data-action');
                    const li = qtyBtn.closest('li');
                    const span = li.querySelector('.qty-value');
                    let qty = parseInt(span.textContent, 10) || 0;
                    qty = (action === 'plus' ? qty + 1 : qty - 1);
                    if (qty < 0) qty = 0;

                    const updateUrl = '@Url.Action("UpdateAjax", "Cart")';
                    const r2 = await fetch(`${updateUrl}?id=${id}&qty=${qty}`);
                    const h2 = await r2.text();
                    document.getElementById('offcanvasCartBody').innerHTML = h2;
                    return;
                }

                const remBtn = e.target.closest('.remove-btn');
                if (remBtn) {
                    e.preventDefault();
                    const id = remBtn.getAttribute('data-id');
                    const updateUrl = '@Url.Action("UpdateAjax", "Cart")';
                    const r3 = await fetch(`${updateUrl}?id=${id}&qty=0`);
                    const h3 = await r3.text();
                    document.getElementById('offcanvasCartBody').innerHTML = h3;
                }
            });
        });
    </script>
}