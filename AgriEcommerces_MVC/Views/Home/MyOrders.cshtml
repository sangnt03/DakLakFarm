@model List<AgriEcommerces_MVC.Models.order>
@{
    ViewData["Title"] = "Đơn hàng của tôi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container py-5">
    <h3><i class="fas fa-shopping-bag"></i> @ViewData["Title"]</h3>

    @* Hiển thị thông báo *@
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle"></i> @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-circle"></i> @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    <!-- Thống kê đơn hàng -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="text-danger" style="-webkit-text-fill-color:orangered">@Model.Count(o => o.status == "Chờ duyệt" || o.status == "Pending")</h5>
                    <small class="text-muted">Chờ duyệt</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="text-info" style="-webkit-text-fill-color:aqua">@Model.Count(o => o.status == "Đã duyệt")</h5>
                    <small class="text-muted">Đang xử lý</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="text-primary">@Model.Count(o => o.status == "Đang vận chuyển")</h5>
                    <small class="text-muted">Đang vận chuyển</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="text-success">@Model.Count(o => o.status == "Đã nhận hàng")</h5>
                    <small class="text-muted">Đã nhận hàng</small>
                </div>
            </div>
        </div>
    </div>
    <br />
    @if (!Model.Any())
    {
        <div class="alert alert-info text-center py-5">
            <i class="fas fa-inbox fa-3x mb-3"></i>
            <h5>Chưa có đơn hàng nào</h5>
            <p>Bạn chưa có đơn hàng nào. Hãy bắt đầu mua sắm ngay!</p>
            <a asp-controller="Home" asp-action="Index" class="btn btn-primary">
                <i class="fas fa-shopping-cart"></i> Mua sắm ngay
            </a>
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 100px;">Mã đơn</th>
                        <th style="width: 100px;" class="text-center">Ngày đặt</th>
                        <th style="width: 120px;" class="text-center">Trạng thái</th>
                        <th style="width: 120px;" class="text-end">Tổng tiền</th>
                        <th class="text-center" style="width: 280px;">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var o in Model)
                    {
                        <tr>
                            <td>
                                <strong class="text-primary">@o.ordercode</strong>
                            </td>
                            <td class="text-center">
                                <small>@(o.orderdate?.ToString("dd/MM/yyyy HH:mm") ?? "-")</small>
                            </td>
                            <td class="text-center">
                                @{
                                    var badgeClass = o.status switch
                                    {
                                        "Pending" => "status-badge bg-warning text-dark",
                                        "Paid" => "bg-info text-success text-dark",
                                        "Chờ duyệt" => "status-badge bg-warning text-dark",
                                        "Đang xử lý" => "bg-info text-dark",
                                        "Đang vận chuyển" => "bg-primary text-dark",
                                        "Đã nhận hàng" => "status-badg bg-success text-dark",
                                        "Đã hủy" => "status-badge bg-danger text-dark",
                                        _ => "bg-secondary"
                                    };
                                }
                                <span class="badge @badgeClass">@o.status</span>
                            </td>
                            <td class="text-end">
                                <strong class="text-success">@o.FinalAmount.ToString("N0") VNĐ</strong>
                            </td>
                            <td>
                                <div class="d-flex flex-wrap gap-1 justify-content-center">
                                    <a asp-action="OrderDetails" asp-route-id="@o.orderid"
                                       class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-eye"></i> Xem chi tiết
                                    </a>

                                    @if (o.status == "Chờ duyệt" || o.status == "Pending")
                                    {
                                        <button type="button" class="btn btn-sm btn-outline-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#cancelModal@(o.orderid)">
                                            <i class="fas fa-times-circle"></i> Hủy đơn
                                        </button>
                                    }

                                    @if (o.status == "Đang vận chuyển")
                                    {
                                        <form asp-action="ConfirmReceived" asp-route-orderid="@o.orderid" method="post"
                                              onsubmit="return confirm('Bạn chắc chắn đã nhận được hàng?');"
                                              style="display: inline;">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-sm btn-outline-success">
                                                <i class="fas fa-check"></i> Đã nhận hàng
                                            </button>
                                        </form>
                                    }

                                    @if (o.status == "Đã nhận hàng")
                                    {
                                        @foreach (var detail in o.orderdetails)
                                        {
                                            @if (detail.productid > 0)
                                            {
                                                <a asp-controller="Review"
                                                   asp-action="Create"
                                                   asp-route-productid="@detail.productid"
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-star"></i> Đánh giá
                                                </a>
                                            }
                                        }
                                    }
                                </div>
                            </td>
                        </tr>

                        @if (o.status == "Chờ duyệt")
                        {
                            <div class="modal fade" id="cancelModal@(o.orderid)" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <form asp-controller="Order" asp-action="CancelOrder" method="post">
                                            <input type="hidden" name="orderId" value="@o.orderid" />
                                            <input type="hidden" name="returnUrl" value="@Url.Action("MyOrders", "Home")" />
                                            @Html.AntiForgeryToken()
                                            <div class="modal-header bg-danger text-white">
                                                <h5 class="modal-title">
                                                    <i class="fas fa-exclamation-triangle"></i> Xác nhận hủy đơn hàng
                                                </h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-info-circle"></i>
                                                    Bạn có chắc chắn muốn hủy đơn hàng <strong>@o.ordercode</strong>?
                                                </div>
                                                <div class="mb-3">
                                                    <label for="cancelReason@(o.orderid)" class="form-label">
                                                        Lý do hủy đơn <span class="text-muted">(không bắt buộc)</span>:
                                                    </label>
                                                    <textarea class="form-control"
                                                  id="cancelReason@(o.orderid)"
                                                  name="cancelReason"
                                                  rows="3"
                                                  placeholder="Ví dụ: Đặt nhầm sản phẩm, muốn thay đổi địa chỉ..."></textarea>
                                                </div>
                                                <div class="bg-light p-3 rounded">
                                                    <p class="mb-2 text-muted small"><strong>Lưu ý khi hủy đơn:</strong></p>
                                                    <ul class="mb-0 small text-muted">
                                                        <li>Mã khuyến mãi (nếu có) sẽ được hoàn lại</li>
                                                        <li>Sản phẩm sẽ được trả lại kho</li>
                                                        <li>Bạn có thể đặt hàng mới bất cứ lúc nào</li>
                                                    </ul>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    <i class="fas fa-times"></i> Đóng
                                                </button>
                                                <button type="submit" class="btn btn-danger">
                                                    <i class="fas fa-check"></i> Xác nhận hủy đơn
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </tbody>
            </table>
        </div>


    }
</div>

@section Scripts {
    <script>
        // Auto hide alerts after 5 seconds
        setTimeout(function() {
            $('.alert').fadeOut('slow');
        }, 5000);
    </script>
}