@model AgriEcommerces_MVC.Models.order
@{
    ViewData["Title"] = $"Chi tiết đơn hàng #{Model.ordercode}";
    Layout = "~/Views/Shared/_Layout.cshtml";
    // Lấy thông tin thanh toán gần nhất (nếu có)
    var payment = Model.Payments?.FirstOrDefault();
}

<div class="container py-5">
    <h3>@ViewData["Title"]</h3>

    <div class="row">
        <div class="col-md-6">
            <p>
                <strong>Ngày đặt:</strong> @(Model.orderdate?.ToString("dd/MM/yyyy HH:mm") ?? "-")<br />
                <strong>Trạng thái:</strong>
                @if (Model.status == "Paid")
                {
                    <span class="badge bg-success">Đã thanh toán</span>
                }
                else if (Model.status == "Pending")
                {

                    <span class="badge bg-warning text-dark">Chờ thanh toán</span>
                }
                else if (Model.status == "Cancelled")
                {

                    <span class="badge bg-danger">Đã hủy</span>
                }
                else
                {

                    <span>@Model.status</span>
                }
                <br />
                <strong>Phương thức TT:</strong> @(payment?.PaymentMethod ?? "Chưa xác định")
            </p>
        </div>
        <div class="col-md-6">
            <p>
                <strong>Tên người nhận:</strong> @Model.customername<br />
                <strong>Số điện thoại:</strong> @Model.customerphone<br />
                <strong>Địa chỉ giao:</strong> @Model.shippingaddress
            </p>
        </div>
    </div>

    <div class="table-responsive mt-3">
        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Ảnh</th>
                    <th>Tên Sản phẩm</th>
                    <th>Số lượng</th>
                    <th>Đơn giá</th>
                    <th>Tạm tính</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var d in Model.orderdetails)
                {
                    <tr>
                        <td>
                            @{
                                var img = d.product.productimages.FirstOrDefault()?.imageurl;
                            }
                            @if (!string.IsNullOrEmpty(img))
                            {
                                <img src="@Url.Content(img.StartsWith("~/") ? img : "~" + img)" width="50" />
                            }
                            else
                            {
                                <span></span>
                            }
                        </td>
                        <td>@d.product.productname</td>
                        <td>@d.quantity</td>
                        <td>@string.Format("{0:N0}", d.unitprice) VNĐ</td>
                        <td>@string.Format("{0:N0}", d.quantity * d.unitprice) VNĐ</td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr class="text-black">
                    <th colspan="4" class="text-end">Tổng tạm tính:</th>
                    <th>@string.Format("{0:N0}", Model.totalamount) VNĐ</th>
                </tr>
                @if (Model.discountamount > 0)
                {
                    <tr class="text-success">
                        <th colspan="4" class="text-end">Giảm giá:</th>
                        <th>-@string.Format("{0:N0}", Model.discountamount) VNĐ</th>
                    </tr>
                }
                <tr style="-webkit-text-fill-color:dodgerblue">
                    <th colspan="4" class="text-end">Phí vận chuyển:</th>
                    <th>@string.Format("{0:N0}", Model.ShippingFee) VNĐ</th>
                </tr>
                <tr style="-webkit-text-fill-color:orange">
                    <th colspan="4" class="text-end">Tổng cộng:</th>
                    <th class="fs-5">@string.Format("{0:N0}", Model.FinalAmount) VNĐ</th>
                </tr>
            </tfoot>
        </table>
    </div>
    <div class="mt-4 d-flex gap-2">
        @* ===== NÚT THANH TOÁN LẠI (Chỉ hiện khi chưa thanh toán và không phải COD) ===== *@
        @if (Model.status == "Pending" && (payment == null || payment.PaymentMethod != "COD"))
        {
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#retryPaymentModal">
                <i class="fas fa-credit-card"></i> Thanh toán ngay
            </button>
        }
    </div>
    <div class="mt-4 d-flex gap-2">
        <a asp-action="MyOrders" class="btn btn-secondary">&larr; Quay lại danh sách</a>
    </div>
</div>

@* ===== MODAL CHỌN PHƯƠNG THỨC THANH TOÁN (Giống trang OrderConfirmation) ===== *@
@if (Model.status == "Pending" && (payment == null || payment.PaymentMethod != "COD"))
{
    <div class="modal fade" id="retryPaymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Chọn phương thức thanh toán</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Vui lòng chọn cổng thanh toán để tiếp tục hoàn tất đơn hàng <strong>#@Model.ordercode</strong>:</p>
                    <div class="d-grid gap-3">
                        <a asp-controller="Payment" asp-action="CreatePayment" asp-route-orderId="@Model.orderid"
                           class="btn btn-outline-primary d-flex align-items-center justify-content-between p-3 border-2">
                            <span class="fw-bold">
                                <i class="fas fa-qrcode me-2"></i> Ví VNPAY
                            </span>
                            <img src="https://vnpay.vn/s1/statics.vnpay.vn/2023/6/0oxhzjmxbksr1686814746087.png" height="30" alt="VNPay">
                        </a>

                        <a asp-controller="Payment" asp-action="CreateMoMoPayment" asp-route-orderId="@Model.orderid"
                           class="btn btn-outline-danger d-flex align-items-center justify-content-between p-3 border-2">
                            <span class="fw-bold">
                                <i class="fas fa-wallet me-2"></i> Ví MoMo
                            </span>
                            <img src="https://developers.momo.vn/v3/assets/images/logo-custom2-57d6118fe524633b89befe8cb63a3956.png" height="30" alt="MoMo">
                        </a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>
}