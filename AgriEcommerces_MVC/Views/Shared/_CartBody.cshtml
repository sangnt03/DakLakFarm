@using AgriEcommerces_MVC.Models.ViewModel
@model CartViewModel

@if (!Model.Items.Any())
{
    <p>Giỏ hàng của bạn đang trống.</p>
}
else
{
    <div id="cartContainer">
        @foreach (var group in Model.Items.GroupBy(i => i.SellerId))
        {
            <div class="cart-group mb-4">
                <h5>Sản phẩm của shop: @group.Key</h5>
                <ul class="list-group mb-3">
                    @foreach (var item in group)
                    {
                        <li class="list-group-item">
                            <div class="row align-items-center">
                                <div class="col-6 d-flex align-items-center">
                                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                                    {
                                        <img src="@Url.Content(item.ImageUrl)"
                                             alt="@item.ProductName"
                                             class="img-fluid rounded me-3"
                                             style="max-width: 80px;" />
                                    }
                                    else
                                    {
                                        <span class="me-3">Không có ảnh</span>
                                    }
                                    <div>
                                        <h5 class="mb-1">@item.ProductName</h5>
                                        <small class="text-muted">
                                            @item.Quantity x @item.UnitPrice.ToString("N0") VNĐ
                                        </small>
                                    </div>
                                </div>

                                <div class="col-6">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="d-flex align-items-center">
                                            <button type="button" class="btn btn-sm btn-outline-secondary me-2 qty-btn" data-id="@item.ProductId" data-action="minus">−</button>
                                            <span class="qty-value">@item.Quantity</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2 qty-btn" data-id="@item.ProductId" data-action="plus">+</button>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-btn" data-id="@item.ProductId">
                                            Xóa
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </li>
                    }
                    <li class="list-group-item d-flex justify-content-between">
                        <strong>Tổng tiền:</strong>
                        <div>
                            <strong>@group.Sum(i => i.Total).ToString("N0") VNĐ</strong>
                            <a asp-controller="Home" asp-action="Payment" asp-route-sellerId="@group.Key" class="btn btn-primary btn-sm ms-3">
                                Thanh toán
                            </a>
                        </div>
                    </li>
                </ul>
                <hr />
            </div>
        }
    </div>
}

@section Scripts {
    <script>
        // Hàm xử lý khi chưa đăng nhập
        function handleUnauthorized() {
            alert('Vui lòng đăng nhập để thực hiện thao tác này!');
            const returnUrl = encodeURIComponent(window.location.pathname + window.location.search);
            window.location.href = '/Account/Login?returnUrl=' + returnUrl;
        }

        // Hàm gọi API với xử lý lỗi
        async function fetchWithAuth(url) {
            try {
                const resp = await fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (resp.status === 401) {
                    handleUnauthorized();
                    return null;
                }

                if (!resp.ok) {
                    console.error('Lỗi API:', resp.status);
                    alert('Có lỗi xảy ra. Vui lòng thử lại!');
                    return null;
                }

                return await resp.text();
            } catch (error) {
                console.error('Lỗi kết nối:', error);
                alert('Không thể kết nối đến server!');
                return null;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', async e => {
                // 1) Xử lý nút + / - trong trang sản phẩm (nếu có)
                const minusOrPlus = e.target.closest('button[data-type]');
                if (minusOrPlus && !minusOrPlus.classList.contains('qty-btn')) {
                    e.preventDefault();
                    const wrapper = minusOrPlus.closest('.quantity-wrapper');
                    const input = wrapper.querySelector('input.input-number');
                    let v = parseInt(input.value, 10) || 0;
                    if (minusOrPlus.getAttribute('data-type') === 'plus') v++;
                    else if (v > 1) v--;
                    input.value = v < 1 ? 1 : v;
                    return;
                }

                // 2) Xử lý Add to Cart
                const addBtn = e.target.closest('.add-to-cart');
                if (addBtn) {
                    e.preventDefault();
                    const id = addBtn.getAttribute('data-id');
                    const wrapper = addBtn.closest('.product-item');
                    const input = wrapper.querySelector('input.input-number');
                    let qty = parseInt(input.value, 10);
                    if (isNaN(qty) || qty < 1) qty = 1;

                    const url = '@Url.Action("AddAjax", "Cart")';
                    const html = await fetchWithAuth(`${url}?id=${id}&qty=${qty}`);
                    if (!html) return;

                    // Cập nhật offcanvas cart
                    const offcanvasBody = document.getElementById('offcanvasCartBody');
                    if (offcanvasBody) {
                        offcanvasBody.innerHTML = html;
                        new bootstrap.Offcanvas(document.getElementById('offcanvasCart')).show();
                    }

                    // Cập nhật cart container nếu có
                    const cartContainer = document.getElementById('cartContainer');
                    if (cartContainer) {
                        cartContainer.innerHTML = html;
                    }
                    return;
                }

                // 3) Xử lý nút + / - trong giỏ hàng (chính và offcanvas)
                const qtyBtn = e.target.closest('.qty-btn');
                if (qtyBtn) {
                    e.preventDefault();
                    const id = qtyBtn.getAttribute('data-id');
                    const action = qtyBtn.getAttribute('data-action');
                    const li = qtyBtn.closest('li');
                    if (!li) {
                        console.error('Không tìm thấy thẻ <li> chứa nút qty-btn');
                        return;
                    }
                    const span = li.querySelector('.qty-value');
                    if (!span) {
                        console.error('Không tìm thấy phần tử .qty-value trong <li>');
                        return;
                    }
                    let qty = parseInt(span.textContent, 10) || 0;
                    qty = (action === 'plus') ? qty + 1 : qty - 1;
                    if (qty < 0) qty = 0;

                    const updateUrl = action === 'minus' ? '@Url.Action("DecrementAjax", "Cart")' : '@Url.Action("UpdateAjax", "Cart")';
                    const url = qty === 0 ? `@Url.Action("UpdateAjax", "Cart")?id=${id}&qty=0` : `${updateUrl}?id=${id}${action === 'plus' ? `&qty=${qty}` : ''}`;

                    const html = await fetchWithAuth(url);
                    if (!html) return;

                    // Cập nhật offcanvas
                    const offcanvasBody = document.getElementById('offcanvasCartBody');
                    if (offcanvasBody) {
                        offcanvasBody.innerHTML = html;
                    }

                    // Cập nhật cart container
                    const cartContainer = document.getElementById('cartContainer');
                    if (cartContainer) {
                        cartContainer.innerHTML = html;
                    }
                    return;
                }

                // 4) Xử lý nút xóa
                const remBtn = e.target.closest('.remove-btn');
                if (remBtn) {
                    e.preventDefault();

                    if (!confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
                        return;
                    }

                    const id = remBtn.getAttribute('data-id');
                    const updateUrl = '@Url.Action("UpdateAjax", "Cart")';

                    const html = await fetchWithAuth(`${updateUrl}?id=${id}&qty=0`);
                    if (!html) return;

                    // Cập nhật offcanvas
                    const offcanvasBody = document.getElementById('offcanvasCartBody');
                    if (offcanvasBody) {
                        offcanvasBody.innerHTML = html;
                    }

                    // Cập nhật cart container
                    const cartContainer = document.getElementById('cartContainer');
                    if (cartContainer) {
                        cartContainer.innerHTML = html;
                    }
                }
            });
        });
    </script>
}