@model AgriEcommerces_MVC.Models.ViewModel.AddressViewModel
@using AgriEcommerces_MVC.Models.ApiModels

<div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

<div class="mb-3">
    <label asp-for="RecipientName" class="form-label"></label>
    <input asp-for="RecipientName" class="form-control" />
    <span asp-validation-for="RecipientName" class="text-danger"></span>
</div>

<div class="mb-3">
    <label asp-for="PhoneNumber" class="form-label"></label>
    <input asp-for="PhoneNumber"
           class="form-control"
           type="text"
           maxlength="10"
           oninput="this.value = this.value.replace(/[^0-9]/g, '')"
           placeholder="Nhập số điện thoại (10 số)" />
    <span asp-validation-for="PhoneNumber" class="text-danger"></span>
</div>

<div class="mb-3">
    <label asp-for="ProvinceCity" class="form-label"></label>
    <select asp-for="ProvinceCity" class="form-select" id="province-select">
        <option value="">-- Chọn Tỉnh/Thành phố --</option>
        @if (ViewBag.Provinces != null)
        {
            foreach (var p in (List<ProvinceApiModel>)ViewBag.Provinces)
            {
                <option value="@p.Name" data-code="@p.Code">@p.Name</option>
            }
        }
    </select>
    <span asp-validation-for="ProvinceCity" class="text-danger"></span>
</div>

<div class="mb-3">
    <label asp-for="District" class="form-label"></label>
    <select asp-for="District" class="form-select" id="district-select" disabled>
        <option value="">-- Chọn Quận/Huyện --</option>
    </select>
    <span asp-validation-for="District" class="text-danger"></span>
</div>

<div class="mb-3">
    <label asp-for="WardCommune" class="form-label"></label>
    <select asp-for="WardCommune" class="form-select" id="ward-select" disabled>
        <option value="">-- Chọn Phường/Xã --</option>
    </select>
    <span asp-validation-for="WardCommune" class="text-danger"></span>
</div>

<div class="mb-3">
    <label asp-for="FullAddress" class="form-label">Địa chỉ chi tiết (Số nhà, tên đường)</label>
    <input asp-for="FullAddress" class="form-control" placeholder="Số nhà, tên đường..." />
    <span asp-validation-for="FullAddress" class="text-danger"></span>
</div>

<!-- Hiển thị phí ship ước tính -->
<div class="mb-3" id="shipping-fee-container" style="display: none;">
    <div class="alert alert-info mb-0">
        <div class="d-flex align-items-center">
            <i class="bi bi-truck me-2"></i>
            <div>
                <strong>Phí ship ước tính:</strong>
                <span id="shipping-fee-amount" class="fs-5 text-primary fw-bold">0đ</span>
                <br>
                <small class="text-muted">
                    Từ Đắk Lắk đến <span id="destination-province" class="fw-semibold"></span>
                </small>
            </div>
        </div>
    </div>
</div>

<div class="mb-3 form-check">
    <input asp-for="IsDefault" type="checkbox" class="form-check-input" />
    <label asp-for="IsDefault" class="form-check-label"></label>
</div>

@section Scripts {
<script>
    
    (function() {
        'use strict';

        const provinceSelect = document.getElementById('province-select');
        const districtSelect = document.getElementById('district-select');
        const wardSelect = document.getElementById('ward-select');
        const shippingFeeContainer = document.getElementById('shipping-fee-container');
        const shippingFeeAmount = document.getElementById('shipping-fee-amount');
        const destinationProvince = document.getElementById('destination-province');

        // Lấy giá trị đã lưu từ Model (dùng cho chế độ Edit)
        const selectedProvinceName = @Html.Raw(Json.Serialize(Model.ProvinceCity ?? ""));
        const selectedDistrictName = @Html.Raw(Json.Serialize(Model.District ?? ""));
        const selectedWardName = @Html.Raw(Json.Serialize(Model.WardCommune ?? ""));

        console.log('Edit Mode Data:', {
            province: selectedProvinceName,
            district: selectedDistrictName,
            ward: selectedWardName
        });

        // Hàm reset dropdown
        function resetSelect(selectElement, placeholder, disabled = true) {
            selectElement.innerHTML = `<option value="">${placeholder}</option>`;
            selectElement.disabled = disabled;
            selectElement.value = "";
        }

        // Hàm điền dữ liệu vào select
        function populateSelect(selectElement, data, selectedValue = null) {
            const placeholders = {
                'district-select': '-- Chọn Quận/Huyện --',
                'ward-select': '-- Chọn Phường/Xã --'
            };

            const placeholder = placeholders[selectElement.id] || '-- Chọn --';
            selectElement.innerHTML = `<option value="">${placeholder}</option>`;

            if (!data || data.length === 0) {
                console.warn(`Không có dữ liệu cho ${selectElement.id}`);
                selectElement.disabled = true;
                return false;
            }

            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = item.name;
                option.setAttribute('data-code', item.code);

                if (selectedValue && item.name === selectedValue) {
                    option.selected = true;
                }

                selectElement.appendChild(option);
            });

            selectElement.disabled = false;
            return true;
        }

        // Hàm gọi API với error handling
        async function fetchData(url, selectElement, selectedValue = null) {
            console.log(`Fetching: ${url}`);

            try {
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log(`Data received for ${selectElement.id}:`, data);

                return populateSelect(selectElement, data, selectedValue);

            } catch (error) {
                console.error(`Lỗi khi tải ${selectElement.id}:`, error);
                selectElement.innerHTML = '<option value="">❌ Lỗi tải dữ liệu</option>';
                selectElement.disabled = true;

                // Hiển thị thông báo lỗi cho user
                alert(`Không thể tải dữ liệu. Vui lòng thử lại.\nLỗi: ${error.message}`);
                return false;
            }
        }

        // Hàm tính phí ship
        async function calculateShippingFee(provinceName) {
            if (!provinceName) {
                shippingFeeContainer.style.display = 'none';
                return;
            }

            console.log('Calculating shipping fee for:', provinceName);

            try {
                const response = await fetch('/CustomerAddress/CalculateShipping', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ provinceCity: provinceName })
                });

                if (!response.ok) {
                    throw new Error('Không thể tính phí ship');
                }

                const result = await response.json();
                console.log('Shipping fee result:', result);

                if (result.success) {
                    shippingFeeAmount.textContent = result.formattedFee;
                    destinationProvince.textContent = provinceName;
                    shippingFeeContainer.style.display = 'block';

                    // Thêm hiệu ứng fade in
                    shippingFeeContainer.classList.add('fade-in');
                } else {
                    console.warn('Không tính được phí ship:', result.message);
                    shippingFeeContainer.style.display = 'none';
                }

            } catch (error) {
                console.error('Lỗi khi tính phí ship:', error);
                shippingFeeContainer.style.display = 'none';
            }
        }

        // Xử lý khi chọn Tỉnh/Thành phố
        provinceSelect.addEventListener('change', async function() {
            console.log('Province changed:', this.value);

            // Reset các select phía dưới
            resetSelect(districtSelect, '-- Đang tải... --', true);
            resetSelect(wardSelect, '-- Chọn Phường/Xã --', true);

            const selectedOption = this.options[this.selectedIndex];
            const provinceCode = selectedOption.getAttribute('data-code');
            const provinceName = this.value;

            // Tính phí ship ngay khi chọn tỉnh
            if (provinceName) {
                await calculateShippingFee(provinceName);
            } else {
                shippingFeeContainer.style.display = 'none';
            }

            if (!provinceCode) {
                console.log('Không có mã tỉnh');
                return;
            }

            console.log('Loading districts for province code:', provinceCode);
            await fetchData(`/api/Provinces/GetDistricts?provinceCode=${provinceCode}`, districtSelect);
        });

        // Xử lý khi chọn Quận/Huyện
        districtSelect.addEventListener('change', async function() {
            console.log('District changed:', this.value);

            resetSelect(wardSelect, '-- Đang tải... --', true);

            const selectedOption = this.options[this.selectedIndex];
            const districtCode = selectedOption.getAttribute('data-code');

            if (!districtCode) {
                console.log('Không có mã quận');
                return;
            }

            console.log('Loading wards for district code:', districtCode);
            await fetchData(`/api/Provinces/GetWards?districtCode=${districtCode}`, wardSelect);
        });

        // Khởi tạo cho chế độ Edit
        async function initializeEditMode() {
            if (!selectedProvinceName) {
                console.log('Không phải chế độ Edit');
                return;
            }

            console.log('Khởi tạo chế độ Edit...');

            // Đặt giá trị Tỉnh
            provinceSelect.value = selectedProvinceName;

            const provinceOption = Array.from(provinceSelect.options)
                .find(opt => opt.value === selectedProvinceName);

            if (!provinceOption) {
                console.error('Không tìm thấy tỉnh:', selectedProvinceName);
                return;
            }

            const provinceCode = provinceOption.getAttribute('data-code');
            console.log('Province code:', provinceCode);

            // Tính phí ship cho địa chỉ đang edit
            await calculateShippingFee(selectedProvinceName);

            // Load Quận/Huyện
            const districtsLoaded = await fetchData(
                `/api/Provinces/GetDistricts?provinceCode=${provinceCode}`,
                districtSelect,
                selectedDistrictName
            );

            if (!districtsLoaded || !selectedDistrictName) {
                console.log('Không load được quận hoặc không có giá trị quận');
                return;
            }

            const districtOption = Array.from(districtSelect.options)
                .find(opt => opt.value === selectedDistrictName);

            if (!districtOption) {
                console.error('Không tìm thấy quận:', selectedDistrictName);
                return;
            }

            const districtCode = districtOption.getAttribute('data-code');
            console.log('District code:', districtCode);

            // Load Phường/Xã
            await fetchData(
                `/api/Provinces/GetWards?districtCode=${districtCode}`,
                wardSelect,
                selectedWardName
            );

            console.log('Hoàn tất khởi tạo Edit mode');
        }

        // Chạy khi DOM đã sẵn sàng
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeEditMode);
        } else {
            initializeEditMode();
        }

    })();
</script>
}
<style>
    @@keyframes fadeIn {
        from

    {
        opacity: 0;
        transform: translateY(-10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    .fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }

    #shipping-fee-container .alert {
        border-left: 4px solid #0d6efd;
    }

    #shipping-fee-amount {
        color: #0d6efd !important;
    }
</style>